FROM --platform=linux/amd64 ubuntu:22.04

# Avoid prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install required packages
RUN apt-get update && apt-get install -y \
    build-essential \
    libssl-dev \
    make \
    gcc \
    socat \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create working directory
WORKDIR /app

# Copy source files
COPY main.c  Makefile /app/

# Build the application
RUN make

# Generate initial keypair if needed
RUN mkdir -p /app/keys

COPY flag.txt /flag.txt

# Command to run when container starts

RUN chmod +x rsa_verify
RUN ["./rsa_verify", "regen-keys"]

ENTRYPOINT socat -T 30 \
    TCP-LISTEN:4200,nodelay,reuseaddr,fork \
    EXEC:"stdbuf -i0 -o0 -e0 ./rsa_verify"
