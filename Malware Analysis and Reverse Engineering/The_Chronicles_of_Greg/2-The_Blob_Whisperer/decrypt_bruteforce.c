#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <openssl/evp.h>
#include <openssl/aes.h>
#include <time.h>

unsigned int generate_seed(unsigned int major, unsigned int minor) {
    unsigned int val = (major << 16) | (minor << 8) | (major ^ minor);
    val = (val ^ val >> 13) * 0x5bd1e995;
    return val ^ val >> 15;
}

int decrypt_and_save(const char* input_filename, const char* output_filename, unsigned int seed) {
    FILE* file = fopen(input_filename, "rb");
    if (!file) {
        perror("fopen input");
        return -1;
    }

    fseek(file, 0, SEEK_END);
    long input_len = ftell(file);
    fseek(file, 0, SEEK_SET);

    unsigned char* input_data = malloc(input_len);
    fread(input_data, 1, input_len, file);
    fclose(file);

    unsigned char key[16], iv[16];
    srand(seed);
    for (int i = 0; i < 16; i++) {
        key[i] = rand() & 0xFF;
        iv[i] = rand() & 0xFF;
    }

    unsigned char* plaintext = malloc(input_len + AES_BLOCK_SIZE);
    int len, plaintext_len;

    EVP_CIPHER_CTX* ctx = EVP_CIPHER_CTX_new();
    EVP_DecryptInit_ex(ctx, EVP_aes_128_cbc(), NULL, key, iv);

    EVP_DecryptUpdate(ctx, plaintext, &len, input_data, input_len);
    plaintext_len = len;

    if (EVP_DecryptFinal_ex(ctx, plaintext + len, &len) > 0) {
        plaintext_len += len;
        FILE* out_file = fopen(output_filename, "wb");
        if (!out_file) {
            perror("fopen output");
            EVP_CIPHER_CTX_free(ctx);
            free(input_data);
            free(plaintext);
            return -1;
        }
        fwrite(plaintext, 1, plaintext_len, out_file);
        fclose(out_file);
        printf("Decrypted successfully: %s\n", output_filename);
    } else {
        printf("Decryption failed: %s\n", output_filename);
    }

    EVP_CIPHER_CTX_free(ctx);
    free(input_data);
    free(plaintext);
    return 0;
}

int main() {
    const char* input_file = "blob.bin";
    char output_file[256];

    for (unsigned int major = 2; major <= 2; major++) {
        for (unsigned int minor = 21; minor <= 41; minor++) {
            unsigned int seed = generate_seed(major, minor);
            snprintf(output_file, sizeof(output_file), "%u.%u_deciphered.bin", major, minor);
            decrypt_and_save(input_file, output_file, seed);
        }
    }

    return 0;
}
